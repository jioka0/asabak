{% extends "./base_blog.html" %}

{% block title %}{% if post_data %}{{ post_data.title }} | NekwasaR Blog{% else %}The Future of Artificial Intelligence:
Transforming Our World | NekwasaR Blog{% endif %}{% endblock %}
{% block fluid_layout %}true{% endblock %}

{% block head_extra %}
<!-- SEO Meta Tags -->
<meta name="description"
    content="{% if post_data %}{{ post_data.excerpt|truncate(160) }}{% else %}Explore how AI is reshaping industries, empowering innovation, and creating unprecedented opportunities for growth and discovery in our rapidly evolving digital landscape.{% endif %}">
<meta name="author" content="{% if post_data %}{{ post_data.author }}{% else %}NekwasaR{% endif %}">
<meta name="keywords"
    content="{% if post_data %}{{ post_data.tags|join(', ') }}{% else %}artificial intelligence, AI, technology, innovation, future, machine learning{% endif %}">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:title"
    content="{% if post_data %}{{ post_data.title }}{% else %}The Future of Artificial Intelligence: Transforming Our World{% endif %}">
<meta property="og:description"
    content="{% if post_data %}{{ post_data.excerpt|truncate(160) }}{% else %}Explore how AI is reshaping industries, empowering innovation, and creating unprecedented opportunities for growth and discovery.{% endif %}">
<meta property="og:image"
    content="{% if post_data and post_data.featured_image %}{{ post_data.featured_image }}{% else %}https://images.unsplash.com/photo-1677442136019-21780ecad995?w=1200&h=630&fit=crop{% endif %}">
<meta property="og:url"
    content="https://blog.nekwasar.com/{% if post_data %}{{ post_data.slug }}{% else %}ai-future-transforming-world{% endif %}">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title"
    content="{% if post_data %}{{ post_data.title }}{% else %}The Future of Artificial Intelligence: Transforming Our World{% endif %}">
<meta name="twitter:description"
    content="{% if post_data %}{{ post_data.excerpt|truncate(160) }}{% else %}Explore how AI is reshaping industries, empowering innovation, and creating unprecedented opportunities for growth and discovery.{% endif %}">
<meta name="twitter:image"
    content="{% if post_data and post_data.featured_image %}{{ post_data.featured_image }}{% else %}https://images.unsplash.com/photo-1677442136019-21780ecad995?w=1200&h=630&fit=crop{% endif %}">

<!-- Google Fonts - Anton -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Hidden element to store post data for JavaScript -->
<div id="post-data" data-post-data='{{ post_data | tojson if post_data else "null" }}' style="display:none;"></div>
<style>
    /* Minimal container overrides for published layout */
    .section-container {
        max-width: none !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 2rem !important;
    }

    /* Ensure main content areas are full width */
    main .section-container,
    section .section-container {
        max-width: none !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Allow base_blog.html fluid layout to work */
    main#route-container[data-fluid="true"] .container {
        max-width: none !important;
        width: 100% !important;
        margin: 0 !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
    }

    /* Mobile responsive padding */
    @media (max-width: 768px) {
        main#route-container[data-fluid="true"] .container {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
    }

    /* Comment section styles */
    .comment-section-collapsed {
        width: 150px;
        min-height: 27px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: all 0.3s ease;
        border: 2px dashed var(--stroke-elements);
        border-radius: 16px;
        padding: 12px;
        box-sizing: border-box;
        position: relative;
    }

    .comment-section-collapsed::before {
        content: '';
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        border: 2px dashed rgb(168 85 247);
        border-radius: 20px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .comment-section-collapsed:hover {
        border-color: rgb(168 85 247) !important;
        /* purple-500 */
        background-color: rgb(245 243 255) !important;
        /* purple-50 */
    }

    .comment-section-collapsed:hover::before {
        opacity: 1;
    }

    .dark .comment-section-collapsed:hover {
        border-color: rgb(168 85 247) !important;
        /* purple-500 */
        background-color: rgb(46 16 101 / 0.3) !important;
        /* purple-900/30 */
    }

    .dark .comment-section-collapsed:hover::before {
        border-color: rgb(168 85 247) !important;
        /* purple-500 */
    }

    .comment-section-expanded {
        animation: fadeInUp 0.3s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Ensure proper focus states */
    .comment-section-collapsed:focus {
        outline: 2px solid rgb(168 85 247);
        outline-offset: 2px;
    }

    /* Modern modal animations */
    .animate-in {
        animation-fill-mode: both;
    }

    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }

    .slide-up {
        animation: slideUp 0.3s ease-out;
    }

    .fade-out {
        animation: fadeOut 0.2s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }

    /* Enhanced focus states for modal */
    [data-comment-modal] button:focus-visible,
    [data-comment-modal] input:focus-visible {
        outline: 2px solid rgb(168 85 247);
        outline-offset: 2px;
    }

    /* Smooth transitions for all interactive elements */
    [data-comment-modal] button,
    [data-comment-modal] input {
        transition: all 0.2s ease;
    }

    /* Duplication Fix: Hide structural elements that leaked into the content body */
    #blog-content-render-area #blog-hero-section,
    #blog-content-render-area #blog-engagement-bar,
    #blog-content-render-area #blog-comments-section,
    #blog-content-render-area aside,
    #blog-content-render-area nav,
    #blog-content-render-area footer,
    #blog-content-render-area #comments {
        display: none !important;
    }
</style>


<!-- Hero Section -->
<section id="blog-hero-section" data-is-template="true"
    class="relative h-[60vh] sm:h-[70vh] min-h-[400px] sm:min-h-[500px] overflow-hidden">
    <div class="absolute inset-0">
        <img src="{% if post_data and post_data.featured_image %}{{ post_data.featured_image }}{% else %}https://images.unsplash.com/photo-1677442136019-21780ecad995?w=1920&h=1080&fit=crop&crop=center{% endif %}"
            alt="{% if post_data %}{{ post_data.title }} Banner{% else %}AI and Technology Innovation{% endif %}"
            class="w-full h-full object-cover">
        <div class="absolute inset-0 bg-gradient-to-r from-black/70 via-black/50 to-black/70"></div>
    </div>

    <div class="relative z-10 flex items-end h-full">
        <div class="max-w-4xl px-4 sm:px-6 lg:px-8 pb-8 sm:pb-16 w-full">
            <div class="max-w-4xl">
                <!-- Category Tag -->
                <div
                    class="inline-flex items-center px-4 py-2 rounded-full bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-500 dark:to-purple-600 text-white text-lg sm:text-xl lg:text-2xl font-bold mb-4 sm:mb-6 shadow-lg">
                    {% if post_data and post_data.tags %}{{ post_data.tags[0] }}{% else %}Technology{% endif %}
                </div>

                <!-- Title -->
                <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-extrabold text-white leading-tight mb-4 sm:mb-6"
                    style="font-family: 'Anton', sans-serif !important; max-width: 100rem !important;">
                    {% if post_data %}{{ post_data.title }}{% else %}The Future of Artificial Intelligence: Transforming
                    Our World{% endif %}
                </h1>

                <!-- Meta Information -->
                <div
                    class="flex flex-wrap items-center gap-4 sm:gap-6 text-white/90 text-base sm:text-lg lg:text-xl no-edit">
                    <span class="flex items-center gap-3 sm:gap-4">
                        <i class="ph-bold ph-user text-lg sm:text-xl lg:text-2xl"></i>
                        By {% if post_data %}{{ post_data.author }}{% else %}NekwasaR{% endif %}
                    </span>
                    <span class="text-white/60 hidden sm:inline text-lg sm:text-xl lg:text-2xl">•</span>
                    <span class="flex items-center gap-3 sm:gap-4">
                        <i class="ph-bold ph-calendar text-lg sm:text-xl lg:text-2xl"></i>
                        {% if post_data and post_data.published_at %}
                        {{ post_data.published_at | strftime('%B %d, %Y') }}
                        {% else %}
                        November 6, 2025
                        {% endif %}
                    </span>
                    <span class="text-white/60 hidden sm:inline text-lg sm:text-xl lg:text-2xl">•</span>
                    <span class="flex items-center gap-3 sm:gap-4">
                        <i class="ph-bold ph-clock text-lg sm:text-xl lg:text-2xl"></i>
                        8 min read
                    </span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Engagement Header Area -->
<section id="blog-engagement-bar" data-is-template="true"
    class="bg-gray-50 dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4">
            <!-- Engagement Stats -->
            <div
                class="flex flex-wrap items-center gap-6 sm:gap-8 text-sm sm:text-base lg:text-lg text-gray-600 dark:text-gray-400">
                <span class="flex items-center gap-3 sm:gap-4">
                    <i class="ph-bold ph-chat-circle text-lg sm:text-xl lg:text-2xl"></i>
                    <span id="comment-count-large"
                        class="hidden sm:inline text-base sm:text-lg lg:text-xl text-black dark:text-white">{{
                        post_data.comment_count or 0 }} Comments</span>
                    <span id="comment-count-small" class="sm:hidden text-base text-black dark:text-white">{{
                        post_data.comment_count or 0 }}</span>
                </span>
                <span class="flex items-center gap-3 sm:gap-4">
                    <i class="ph-bold ph-eye text-lg sm:text-xl lg:text-2xl"></i>
                    <span class="hidden sm:inline text-base sm:text-lg lg:text-xl text-black dark:text-white">{{
                        post_data.view_count or 0 }} Views</span>
                    <span class="sm:hidden text-base text-black dark:text-white">{{ post_data.view_count or 0 }}</span>
                </span>
                <span class="flex items-center gap-3 sm:gap-4 like-section" data-post-id="{{ post_data.id or 1 }}">
                    <button onclick="toggleLike()"
                        class="flex items-center gap-3 sm:gap-4 hover:text-red-500 dark:hover:text-red-400 transition-colors">
                        <i class="ph-bold ph-heart text-lg sm:text-xl lg:text-2xl like-icon"></i>
                        <span
                            class="like-count hidden sm:inline text-base sm:text-lg lg:text-xl text-black dark:text-white">{{
                            post_data.like_count or 0 }}</span>
                        <span class="like-count sm:hidden text-base text-black dark:text-white">{{ post_data.like_count
                            or 0 }}</span>
                        <span
                            class="hidden sm:inline text-base sm:text-lg lg:text-xl text-black dark:text-white">Likes</span>
                    </button>
                </span>
                <span class="flex items-center gap-3 sm:gap-4">
                    <button onclick="openShareModal()"
                        class="flex items-center gap-3 sm:gap-4 hover:text-purple-600 dark:hover:text-purple-400 transition-colors">
                        <i class="ph-bold ph-share-network text-lg sm:text-xl lg:text-2xl"></i>
                        <span
                            class="hidden sm:inline text-base sm:text-lg lg:text-xl text-black dark:text-white">Share</span>
                    </button>
                </span>
            </div>

            <!-- Join Conversation Button -->
            <button onclick="emergencyFunctionCaller('scrollToComments')"
                class="inline-flex items-center gap-4 px-4 sm:px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-500 dark:to-purple-600 text-white text-base sm:text-lg lg:text-xl font-semibold rounded-xl hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-600 dark:hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-lg w-full sm:w-auto justify-center">
                <i class="ph-bold ph-chat-circle-dots text-lg sm:text-xl lg:text-2xl"></i>
                <span class="hidden sm:inline">Join the Conversation</span>
                <span class="sm:hidden">Comment</span>
            </button>
        </div>
    </div>
</section>

<!-- Page Sections - Only show if content is not already provided (Prevents recursive nesting) -->
{% if not (post_data and post_data.content) %}

<!-- Introductory Section -->
<section class="py-16 bg-white dark:bg-gray-950">
    <div class="max-w-4xl px-4 sm:px-6 lg:px-8">
        <!-- Intro Text -->
        <p class="text-lg text-gray-700 dark:text-gray-200 leading-relaxed mb-8">
            Artificial Intelligence represents one of the most significant technological breakthroughs of our time.
            As we stand at the precipice of a new digital age, AI is not just transforming how we work and live—it's
            fundamentally reshaping the very fabric of human society. From healthcare to finance, education to
            transportation, the ripple effects of AI innovation are felt across every industry.
        </p>

        <!-- Inline Social Share -->
        <div class="flex items-center gap-6 sm:gap-8 mb-12">
            <span class="text-base sm:text-lg lg:text-xl font-semibold text-black dark:text-white">Share:</span>
            <button onclick="shareOnFacebook()"
                class="p-3 sm:p-4 text-black dark:text-white hover:text-purple-600 dark:hover:text-purple-400 transition-all duration-300 transform hover:scale-110 shadow-md hover:shadow-lg rounded-full">
                <i class="ph-bold ph-facebook-logo text-2xl sm:text-3xl lg:text-4xl"></i>
            </button>
            <button onclick="shareOnTelegram()"
                class="p-3 sm:p-4 text-black dark:text-white hover:text-purple-700 dark:hover:text-purple-500 transition-all duration-300 transform hover:scale-110 shadow-md hover:shadow-lg rounded-full">
                <i class="ph-bold ph-telegram-logo text-2xl sm:text-3xl lg:text-4xl"></i>
            </button>
            <button onclick="shareOnReddit()"
                class="p-3 sm:p-4 text-black dark:text-white hover:text-purple-800 dark:hover:text-purple-600 transition-all duration-300 transform hover:scale-110 shadow-md hover:shadow-lg rounded-full">
                <i class="ph-bold ph-reddit-logo text-2xl sm:text-3xl lg:text-4xl"></i>
            </button>
            <button onclick="shareOnWhatsApp()"
                class="p-3 sm:p-4 text-black dark:text-white hover:text-green-600 dark:hover:text-green-400 transition-all duration-300 transform hover:scale-110 shadow-md hover:shadow-lg rounded-full">
                <i class="ph-bold ph-whatsapp-logo text-2xl sm:text-3xl lg:text-4xl"></i>
            </button>
        </div>

        <!-- Ad Banner #1 -->
        <div
            class="bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 text-center">
            <span
                class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Advertisement</span>
            <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">Responsive Ad Banner</div>
            <!-- Ad Space 1: Intro Banner -->
            <div class="ad-space" id="ad-space-1" data-ad-position="intro-banner"
                style="min-height: 120px; max-height: 150px;">
                <!-- JavaScript Ad Snippet -->
                <script type="text/javascript">
                    atOptions = {
                        'key': 'df676795dca3c493d602b48a6981808d',
                        'format': 'iframe',
                        'height': 250,
                        'width': 728,
                        'params': {}
                    };
                </script>
                <script type="text/javascript"
                    src="https://www.highperformanceformat.com/df676795dca3c493d602b48a6981808d/invoke.js"></script>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Main Content Layout -->
<section class="py-8 sm:py-12 lg:py-16 bg-gray-50 dark:bg-gray-950">
    <div class="w-full px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">
            <!-- Left Sidebar -->
            <aside data-is-template="true" class="lg:col-span-2 order-2 lg:order-1">
                <div class="sticky top-20 sm:top-24 space-y-6">
                    <!-- Related Posts -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-8 shadow-lg">
                        <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 mb-6 flex items-center gap-3">
                            <i class="ph-bold ph-link text-2xl"></i>
                            Related Posts
                        </h3>
                        <div class="space-y-6">
                            <a href="/blog/ai-revolutionizing-healthcare" class="flex gap-4 group">
                                <img src="https://images.unsplash.com/photo-1559136555-9303baea8ebd?w=80&h=60&fit=crop"
                                    class="w-20 h-16 rounded-lg object-cover flex-shrink-0 shadow-md" alt="">
                                <div class="flex-1">
                                    <h4
                                        class="text-xs font-semibold text-gray-900 dark:text-gray-100 mb-2 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors leading-tight">
                                        How AI is Revolutionizing Healthcare</h4>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">12.5k views</span>
                                </div>
                            </a>
                            <a href="/blog/rise-of-quantum-computing" class="flex gap-4 group">
                                <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=80&h=60&fit=crop"
                                    class="w-20 h-16 rounded-lg object-cover flex-shrink-0 shadow-md" alt="">
                                <div class="flex-1">
                                    <h4
                                        class="text-xs font-semibold text-gray-900 dark:text-gray-100 mb-2 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors leading-tight">
                                        The Rise of Quantum Computing</h4>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">8.9k views</span>
                                </div>
                            </a>
                            <a href="/blog/machine-learning-ethics" class="flex gap-4 group">
                                <img src="https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=80&h=60&fit=crop"
                                    class="w-20 h-16 rounded-lg object-cover flex-shrink-0 shadow-md" alt="">
                                <div class="flex-1">
                                    <h4
                                        class="text-xs font-semibold text-gray-900 dark:text-gray-100 mb-2 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors leading-tight">
                                        Machine Learning Ethics</h4>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">6.7k views</span>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Trending Now -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-8 shadow-lg">
                        <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 mb-6 flex items-center gap-3">
                            <i class="ph-bold ph-trend-up text-2xl"></i>
                            Trending Now
                        </h3>
                        <div class="space-y-6">
                            <a href="/blog/ai-changing-finance" class="flex gap-4 group">
                                <img src="https://images.unsplash.com/photo-1559136555-9303baea8ebd?w=80&h=60&fit=crop"
                                    class="w-20 h-16 rounded-lg object-cover flex-shrink-0 shadow-md" alt="">
                                <div class="flex-1">
                                    <h4
                                        class="text-xs font-semibold text-gray-900 dark:text-gray-100 mb-2 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors leading-tight">
                                        How AI is Changing Finance</h4>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">2.1k views</span>
                                </div>
                            </a>
                            <a href="/blog/crypto-market-2025" class="flex gap-4 group">
                                <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=80&h=60&fit=crop"
                                    class="w-20 h-16 rounded-lg object-cover flex-shrink-0 shadow-md" alt="">
                                <div class="flex-1">
                                    <h4
                                        class="text-xs font-semibold text-gray-900 dark:text-gray-100 mb-2 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors leading-tight">
                                        Crypto Market Analysis 2025</h4>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">1.8k views</span>
                                </div>
                            </a>
                            <a href="/blog/real-estate-trends" class="flex gap-4 group">
                                <img src="https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=80&h=60&fit=crop"
                                    class="w-20 h-16 rounded-lg object-cover flex-shrink-0 shadow-md" alt="">
                                <div class="flex-1">
                                    <h4
                                        class="text-xs font-semibold text-gray-900 dark:text-gray-100 mb-2 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors leading-tight">
                                        Real Estate Trends</h4>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">1.5k views</span>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Column -->
            <main class="lg:col-span-8 order-1 lg:order-2">
                {% if not (post_data and post_data.content) %}
                <article
                    class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-800 overflow-hidden w-full">
                    <div class="p-6 w-full max-w-none">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">The Evolution of Wealth in
                            2025</h2>
                        <p class="text-lg text-gray-700 dark:text-gray-200 leading-relaxed mb-6">
                            The billionaire landscape has undergone significant transformation. Technology, renewable
                            energy, and digital innovation now dominate the narratives shaping the global economy.
                        </p>
                        <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg p-8 mb-8">
                            <h3 class="text-2xl font-bold mb-3">The Power of Visual Storytelling</h3>
                            <p class="text-lg leading-relaxed opacity-90 mb-5">
                                Video content has revolutionized how we communicate complex ideas. Here we dive deep
                                into the methodologies that drive innovation.
                            </p>
                        </div>

                        <div class="prose prose-lg max-w-full">
                            <h3 id="vision" class="text-2xl font-semibold text-gray-900 dark:text-gray-100">The
                                Visionary's Perspective</h3>
                            <p class="text-lg text-gray-700 dark:text-gray-200 leading-relaxed">
                                Innovation begins with vision—the ability to see beyond the present constraints and
                                imagine new possibilities.
                            </p>
                            <blockquote
                                class="border-l-4 border-purple-500 pl-6 italic text-gray-700 dark:text-gray-200 my-6">
                                "Innovation is about understanding people and solving their real problems in ways
                                they've never imagined."
                            </blockquote>
                            <h3 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mt-8">Innovation in
                                Action</h3>
                            <p class="text-lg text-gray-700 dark:text-gray-200 leading-relaxed">
                                We studied teams that bring AI, deep tech, and human insight together to drive
                                meaningful change.
                            </p>
                            <h3 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mt-8">The Human Element
                            </h3>
                            <p class="text-lg text-gray-700 dark:text-gray-200 leading-relaxed mb-6">
                                High-performance teams combine psychological safety with a relentless focus on purpose.
                            </p>

                            <div
                                class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700 rounded-lg p-6 my-10 text-center">
                                <i
                                    class="ph-bold ph-chat-circle-dots text-2xl text-purple-600 dark:text-purple-400 mb-3 block"></i>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">What do you
                                    think so far?</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">Share your thoughts on the billionaire
                                    rankings</p>
                                <button onclick="emergencyFunctionCaller('scrollToComments')"
                                    class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 bg-purple-600 dark:bg-purple-500 text-white text-sm font-medium rounded-lg hover:bg-purple-700 dark:hover:bg-purple-600 transition-colors w-full sm:w-auto justify-center">
                                    <i class="ph-bold ph-chat-circle-dots text-sm sm:text-base"></i>
                                    <span class="hidden sm:inline">Leave a Comment</span>
                                    <span class="sm:hidden">Comment</span>
                                </button>
                            </div>

                            <div
                                class="bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 text-center my-12">
                                <span
                                    class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Advertisement</span>
                                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">Mid-Article Banner Ad</div>
                                <!-- Ad Space 2: Mid-Article Banner -->
                                <div class="ad-space" id="ad-space-2" data-ad-position="mid-article"
                                    style="min-height: 280px; max-height: 320px;">
                                    <!-- JavaScript Ad Snippet -->
                                    <script type="text/javascript">
                                        atOptions = {
                                            'key': 'df676795dca3c493d602b48a6981808d',
                                            'format': 'iframe',
                                            'height': 250,
                                            'width': 300,
                                            'params': {}
                                        };
                                    </script>
                                    <script type="text/javascript"
                                        src="https://www.highperformanceformat.com/df676795dca3c493d602b48a6981808d/invoke.js"></script>
                                </div>
                            </div>

                            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mt-4">1. Elon Musk – $285
                                Billion</h3>
                            <p class="text-lg text-gray-700 dark:text-gray-200 leading-relaxed mb-6">
                                Musk continues to shepherd electric vehicles, space exploration, and AI research,
                                leveraging bold narratives to keep communities aligned with his grand vision of a
                                multiplanetary, automated future.
                            </p>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">2. Jeff Bezos – $195
                                Billion</h3>
                            <p class="text-lg text-gray-700 dark:text-gray-200 leading-relaxed mb-6">
                                While building Blue Origin, Bezos keeps Amazon's logistics automation and cloud
                                infrastructure tightly focused, narrating every innovation as a customer-first
                                evolution.
                            </p>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">3. Bernard Arnault –
                                $180 Billion</h3>
                            <p class="text-lg text-gray-700 dark:text-gray-200 leading-relaxed mb-6">
                                Arnault blends artistic direction with data-backed brand strategy, proving that
                                culturally rich storytelling and innovation-driven craftsmanship can lift entire
                                industries.
                            </p>
                        </div>

                        <div
                            class="bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-8 my-12">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4">The Future of
                                Billionaire Wealth</h2>
                            <p class="text-lg text-gray-700 dark:text-gray-300 leading-relaxed mb-6">
                                As we look toward the future, several trends are likely to shape the billionaire
                                landscape. Technology innovation, sustainable energy, and digital transformation will
                                continue to create new opportunities for wealth creation.
                            </p>

                            <div
                                class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Key Takeaways
                                </h3>
                                <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                    <li class="flex items-start gap-2">
                                        <span class="text-purple-600 dark:text-purple-400 mt-1">•</span>
                                        Technology and innovation remain the primary drivers of wealth creation.
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-blue-600 dark:text-blue-400 mt-1">•</span>
                                        Diversification across multiple industries provides stability.
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-blue-600 dark:text-blue-400 mt-1">•</span>
                                        Strategic philanthropy can enhance both social impact and financial strategy.
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-blue-600 dark:text-blue-400 mt-1">•</span>
                                        Adaptability to market changes is crucial for long-term success.
                                    </li>
                                </ul>
                            </div>

                            <div class="text-center">
                                <h4 class="text-lg font-semibold text-black dark:text-white mb-4">Share this article
                                </h4>
                                <div class="flex justify-center gap-3 flex-wrap">
                                    <button onclick="shareOnReddit()"
                                        class="inline-flex items-center gap-2 px-4 py-2 bg-purple-500 dark:bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-600 dark:hover:bg-purple-700 transition-colors">
                                        <i class="ph-bold ph-reddit-logo text-base"></i>
                                        Reddit
                                    </button>
                                    <button onclick="shareOnTelegram()"
                                        class="inline-flex items-center gap-2 px-4 py-2 bg-purple-700 dark:bg-purple-800 text-white text-sm font-medium rounded-lg hover:bg-purple-800 dark:hover:bg-purple-900 transition-colors">
                                        <i class="ph-bold ph-telegram-logo text-base"></i>
                                        Telegram
                                    </button>
                                    <button onclick="shareOnFacebook()"
                                        class="inline-flex items-center gap-2 px-4 py-2 bg-purple-800 dark:bg-purple-900 text-white text-sm font-medium rounded-lg hover:bg-purple-900 dark:hover:bg-black transition-colors">
                                        <i class="ph-bold ph-facebook-logo text-base"></i>
                                        Facebook
                                    </button>
                                    <button onclick="shareOnWhatsApp()"
                                        class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 dark:bg-green-700 text-white text-sm font-medium rounded-lg hover:bg-green-700 dark:hover:bg-green-800 transition-colors">
                                        <i class="ph-bold ph-whatsapp-logo text-base"></i>
                                        WhatsApp
                                    </button>
                                    <button onclick="copyLink()"
                                        class="inline-flex items-center gap-2 px-4 py-2 bg-gray-600 dark:bg-gray-700 text-white text-sm font-medium rounded-lg hover:bg-gray-700 dark:hover:bg-gray-800 transition-colors">
                                        <i class="ph-bold ph-copy text-base"></i>
                                        Copy Link
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
                {% else %}
                <div id="blog-content-render-area">
                    {{ post_data.content | safe }}
                </div>
                {% endif %}

                <!-- Comments Section -->
                <section id="blog-comments-section" data-is-template="true"
                    class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 mt-8 no-edit">
                    <div class="p-8">
                        <!-- Section Header -->
                        <div
                            class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8 pb-6 border-b border-gray-100 dark:border-gray-700">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg">
                                    <i class="ph-bold ph-chat-circle-dots text-white text-2xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Discussion</h2>
                                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Join the conversation</p>
                                </div>
                            </div>
                            <span id="comment-count-badge"
                                class="px-5 py-2.5 bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-500 dark:to-purple-600 text-white text-base font-semibold rounded-full shadow-lg">{{
                                post_data.comment_count or 0 }} Comments</span>
                        </div>

                        <!-- Collapsed Comment Box (Initial State) -->
                        <div class="comment-section-collapsed cursor-pointer rounded-2xl border-2 border-dashed border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 p-6 text-center group mb-8"
                            onclick="emergencyFunctionCaller('expandCommentSection')" id="comment-section-collapsed">
                            <div
                                class="flex flex-col items-center justify-center gap-3 text-gray-500 dark:text-gray-400">
                                <div
                                    class="w-16 h-16 rounded-2xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center group-hover:bg-purple-200 dark:group-hover:bg-purple-800/40 transition-colors">
                                    <i
                                        class="ph-bold ph-pencil-simple text-3xl group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors"></i>
                                </div>
                                <span class="text-lg font-medium" style="width: 160px; display: inline-block;">Share
                                    your thoughts...</span>
                                <span class="text-sm text-gray-400 dark:text-gray-500">Click to write a comment</span>
                            </div>
                        </div>

                        <!-- Expanded Comment Box (Hidden Initially) -->
                        <div class="comment-section-expanded hidden" id="comment-section-expanded">
                            <div class="mb-8">
                                <div class="relative group cursor-text mb-4" style="cursor: text !important;">
                                    <textarea
                                        class="w-full border-2 border-gray-200 dark:border-gray-600 rounded-2xl p-5 text-lg comment-textarea bg-white dark:bg-gray-800 placeholder-gray-400 dark:placeholder-gray-500 caret-purple-600 dark:caret-purple-400 transition-all duration-300 focus:ring-4 focus:ring-purple-500/20 dark:focus:ring-purple-400/20 focus:border-purple-500 dark:focus:border-purple-400 resize-none shadow-sm hover:shadow-md focus:shadow-lg"
                                        rows="5" placeholder="What are your thoughts?" style="min-height: 150px;"
                                        id="comment-textarea-main">
                                        </textarea>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                    <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
                                        <span class="flex items-center gap-2">
                                            <i class="ph-bold ph-check-circle text-green-500"></i>
                                            <span>Auto-saved</span>
                                        </span>
                                    </div>
                                    <button onclick="openCommentModal()"
                                        class="px-8 py-4 bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-500 dark:to-purple-600 text-lg font-semibold rounded-2xl hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-600 dark:hover:to-purple-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-purple-500/30 dark:focus:ring-purple-400/30"
                                        id="comment-submit-btn">
                                        <span class="flex items-center gap-3">
                                            <i class="ph-bold ph-paper-plane-right text-xl"></i>
                                            <span>Post Comment</span>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Comments List -->
                        <div class="space-y-6" id="dynamic-comments-list">
                            <!-- Comments will be loaded here dynamically -->
                        </div>
                    </div>
                </section>
            </main>

            <!-- Right Sidebar -->
            <aside data-is-template="true" class="lg:col-span-2 order-3 no-edit">
                <div class="sticky top-20 space-y-6">
                    <!-- Newsletter Signup -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-8 shadow-lg">
                        <h4 class="text-sm font-bold text-gray-900 dark:text-gray-100 mb-4">Stay Updated</h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-8 leading-relaxed">Get the latest insights
                            on technology and wealth building.</p>
                        <form id="sidebarNewsletterForm" onsubmit="subscribeNewsletter(event)">
                            <input type="email" id="newsletterEmail" name="email" placeholder="Your email address"
                                required
                                class="w-full px-6 py-4 border border-gray-300 dark:border-gray-600 rounded-xl mb-6 text-base focus:ring-2 focus:ring-purple-500 dark:focus:ring-purple-400 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 transition-all duration-300">
                            <button type="submit" id="newsletterSubmitBtn"
                                class="w-full px-8 py-4 bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-500 dark:to-purple-600 text-white text-lg font-semibold rounded-xl hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-600 dark:hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                Subscribe
                            </button>
                            <div id="newsletterMessage" class="mt-4 text-sm hidden"></div>
                        </form>
                    </div>

                    <!-- Follow Button -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-8 shadow-lg">
                        <h4 class="text-sm font-bold text-gray-900 dark:text-gray-100 mb-4">Follow NekwasaR</h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-8 leading-relaxed">Join our community and
                            stay connected with the latest updates.</p>
                        <a href="https://www.instagram.com/nekwasar" target="_blank" rel="noopener noreferrer"
                            class="w-full flex items-center justify-center gap-4 px-8 py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-pink-500 text-white text-xl font-semibold rounded-xl hover:from-pink-600 hover:via-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105 shadow-xl hover:shadow-2xl">
                            <i class="ph-bold ph-instagram-logo text-2xl"></i>
                            <span>Follow on Instagram</span>
                        </a>
                    </div>

                    <!-- Ad Widget -->
                    <div
                        class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-8 text-center shadow-lg">
                        <span
                            class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide mb-4 block">Sponsored</span>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-8 font-medium">Premium Sidebar
                            Advertisement</p>
                        <div
                            class="mt-6 h-48 bg-gradient-to-br from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-800 rounded-xl flex items-center justify-center text-lg text-gray-500 dark:text-gray-400 font-semibold shadow-inner">
                            Ad Space
                        </div>
                        <!-- Ad Space 3: Sidebar Widget -->
                        <div class="ad-space" id="ad-space-3" data-ad-position="sidebar-widget"
                            style="min-height: 580px; max-height: 620px;">
                            <!-- JavaScript Ad Snippet -->
                            <script type="text/javascript">
                                atOptions = {
                                    'key': 'df676795dca3c493d602b48a6981808d',
                                    'format': 'iframe',
                                    'height': 600,
                                    'width': 160,
                                    'params': {}
                                };
                            </script>
                            <script type="text/javascript"
                                src="https://www.highperformanceformat.com/df676795dca3c493d602b48a6981808d/invoke.js"></script>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    </div>
</section>

{% endblock %}

{% block footer_content %}
<div class="footer-main">
    <div class="footer-brand">
        <div class="footer-logo">NekwasaR</div>
        <p class="footer-description">Exploring the frontiers of technology, innovation, and digital transformation.</p>
        <div class="footer-social">
            <a href="https://www.reddit.com/user/nekwasar/" class="social-link" target="_blank"><i
                    class="ph-bold ph-reddit-logo"></i></a>
            <a href="https://www.facebook.com/nekwasar" class="social-link" target="_blank"><i
                    class="ph-bold ph-facebook-logo"></i></a>
            <a href="https://www.instagram.com/nekwasar" class="social-link" target="_blank"><i
                    class="ph-bold ph-instagram-logo"></i></a>
            <a href="https://wa.me/2348164806578" class="social-link" target="_blank"><i
                    class="ph-bold ph-whatsapp-logo"></i></a>
            <a href="https://x.com/nekwasar" class="social-link" target="_blank"><i class="ph-bold ph-x-logo"></i></a>
        </div>
    </div>
    <div class="footer-links">
        <div class="link-column">
            <h4>PAGES</h4>
            <a href="#technology">Technology</a>
            <a href="#innovation">Innovation</a>
            <a href="#business">Business</a>
            <a href="#others">Others</a>
        </div>
        <div class="link-column">
            <h4>LEGAL & PRIVACY</h4>
            <a href="#copyright">Copyright</a>
            <a href="#disclaimer">Disclaimer</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize post data from hidden element
    (function () {
        const postDataElement = document.getElementById('post-data');
        if (postDataElement) {
            try {
                const postDataValue = postDataElement.getAttribute('data-post-data');

                if (!postDataValue || postDataValue === 'null' || postDataValue === 'undefined' || postDataValue.trim() === '') {
                    window.postData = null;
                } else {
                    try {
                        window.postData = JSON.parse(postDataValue);
                    } catch (parseError) {
                        // Try to clean up malformed JSON
                        const cleanedValue = postDataValue.replace(/[\r\n\t]/g, ' ').trim();
                        try {
                            window.postData = JSON.parse(cleanedValue);
                        } catch (secondError) {
                            window.postData = null;
                        }
                    }
                }
            } catch (e) {
                window.postData = null;
            }
        } else {
            window.postData = null;
        }
    })();
</script>
<script>
    // IMMEDIATE EVENT ATTACHMENT - Runs before DOMContentLoaded
    (function () {
        'use strict';

        // Global state
        window.commentSystemState = {
            expanded: false,
            initialized: false,
            postId: null,
            replyToId: null
        };

        // Immediate button attachment (runs immediately) - MAKE THIS GLOBAL
        window.attachImmediateEvents = function () {
            try {
                // Attach collapsed comment section click
                const collapsedSection = document.getElementById('comment-section-collapsed');
                if (collapsedSection && !collapsedSection.hasAttribute('data-attached')) {
                    collapsedSection.setAttribute('data-attached', 'true');
                    collapsedSection.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.expandCommentSection && window.expandCommentSection();
                    });
                }

                // Attach scroll buttons
                const scrollButtons = document.querySelectorAll('button[onclick*="scrollToComments"]');
                scrollButtons.forEach(function (btn, index) {
                    if (!btn.hasAttribute('data-attached')) {
                        btn.setAttribute('data-attached', 'true');
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            window.scrollToComments && window.scrollToComments();
                        });
                    }
                });

                // Attach like buttons
                const likeButtons = document.querySelectorAll('button[onclick="toggleLike()"]');
                likeButtons.forEach(function (btn, index) {
                    if (!btn.hasAttribute('data-attached')) {
                        btn.setAttribute('data-attached', 'true');
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            window.toggleLike && window.toggleLike();
                        });
                    }
                });

                // Attach share buttons
                const shareButtons = document.querySelectorAll('button[onclick="openShareModal()"]');
                shareButtons.forEach(function (btn, index) {
                    if (!btn.hasAttribute('data-attached')) {
                        btn.setAttribute('data-attached', 'true');
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            window.openShareModal && window.openShareModal();
                        });
                    }
                });

            } catch (error) {
                console.error('Error in attachImmediateEvents:', error);
            }
        };

        // Run immediately and also after DOM loads
        window.attachImmediateEvents();

        // Re-run after DOM content loads (belt and suspenders)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.attachImmediateEvents);
        } else {
            // DOM already loaded, attach again just in case
            setTimeout(window.attachImmediateEvents, 100);
        }

        // Also run on window load
        window.addEventListener('load', window.attachImmediateEvents);

    })();

    // MAIN COMMENT SYSTEM - Enhanced with error handling
    (function () {
        'use strict';

        // Global variables
        let currentPostId = null;
        let replyToCommentId = null;

        // Initialize on page load with enhanced error handling
        document.addEventListener('DOMContentLoaded', function () {
            try {
                currentPostId = getPostIdFromURL();
                window.commentSystemState.postId = currentPostId;

                if (currentPostId) {
                    loadComments(currentPostId);
                    setupCommentForm();
                    checkLikeStatus(currentPostId);
                }

                // Set up mutation observer for dynamically added elements
                setupMutationObserver();

                // Set up theme change observer
                setupThemeObserver();

                // Set textarea color based on theme
                updateTextareaTheme();

                // Clear any default textarea content
                const textarea = document.getElementById('comment-textarea-main');
                if (textarea) {
                    textarea.value = '';
                }

                window.commentSystemState.initialized = true;
            } catch (error) {
                console.error('Error initializing comment system:', error);
            }
        });

        // Mutation observer for dynamic elements
        function setupMutationObserver() {
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function (node) {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Re-attach events to newly added buttons
                                attachEventsToElement(node);
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Theme change observer
        function setupThemeObserver() {
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        updateTextareaTheme();
                    }
                });
            });

            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class']
            });
        }

        // Attach events to a specific element and its children
        function attachEventsToElement(element) {
            try {
                // Attach events to buttons within this element
                const buttons = element.querySelectorAll ? element.querySelectorAll('button') : [];
                buttons.forEach(function (btn) {
                    if (btn.onclick && typeof btn.onclick === 'string') {
                        const onclickAttr = btn.onclick.toString();
                        if (onclickAttr.includes('scrollToComments') && !btn.hasAttribute('data-attached')) {
                            btn.setAttribute('data-attached', 'true');
                            btn.addEventListener('click', function (e) {
                                e.preventDefault();
                                window.scrollToComments();
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('Error attaching events to element:', error);
            }
        }

        // Get post ID from URL
        function getPostIdFromURL() {
            const path = window.location.pathname;
            const match = path.match(/^\/blog\/(\d+)/);
            return match ? parseInt(match[1]) : (window.postData?.id || 1);
        }

        // Update textarea color based on theme
        function updateTextareaTheme() {
            const textarea = document.getElementById('comment-textarea-main');
            if (textarea) {
                const isDark = document.documentElement.classList.contains('dark');
                textarea.style.color = isDark ? 'white' : 'black';
            }
        }

        // Setup comment form (only when expanded)
        function setupCommentForm() {
            // Only setup if expanded section is visible
            const expandedSection = document.getElementById('comment-section-expanded');
            if (!expandedSection || expandedSection.classList.contains('hidden')) {
                return;
            }

            const textarea = document.querySelector('.comment-textarea');
            const submitBtn = document.querySelector('button[onclick="openCommentModal()"]');

            if (textarea && submitBtn) {
                // Remove existing event listeners to prevent duplicates
                submitBtn.onclick = null;
                textarea.removeEventListener('input', handleTextareaInput);
                textarea.removeEventListener('keydown', handleTextareaKeydown);
                textarea.removeEventListener('focus', handleTextareaFocus);
                textarea.removeEventListener('blur', handleTextareaBlur);

                submitBtn.onclick = function (e) {
                    e.preventDefault();
                    openCommentModal();
                };

                // Add auto-resize functionality
                textarea.addEventListener('input', handleTextareaInput);

                // Add character counter
                let charCount = textarea.parentNode.querySelector('.char-counter');
                if (!charCount) {
                    charCount = document.createElement('div');
                    charCount.className = 'char-counter text-xs text-gray-500 dark:text-gray-400 mt-1';
                    textarea.parentNode.appendChild(charCount);
                }
                charCount.textContent = '0 / 500 characters';

                textarea.addEventListener('input', function () {
                    const count = this.value.length;
                    charCount.textContent = `${count} / 500 characters`;

                    // Change color when approaching limit
                    if (count > 450) {
                        charCount.className = 'char-counter text-xs text-red-500 dark:text-red-400 mt-1 font-medium';
                    } else {
                        charCount.className = 'char-counter text-xs text-gray-500 dark:text-gray-400 mt-1';
                    }
                });

                // Add Enter key submission
                textarea.addEventListener('keydown', handleTextareaKeydown);

                // Add placeholder animation
                textarea.addEventListener('focus', handleTextareaFocus);
                textarea.addEventListener('blur', handleTextareaBlur);
            }
        }

        // Event handler functions
        function handleTextareaInput() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        }

        function handleTextareaKeydown(e) {
            // Enter key submits comment, Shift+Enter creates new line
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // Shift+Enter: allow default behavior (new line)
                    return;
                } else {
                    // Enter: submit comment
                    e.preventDefault();
                    if (this.value.trim()) {
                        openCommentModal();
                    } else {
                        showNotification('Please write a comment before submitting.', 'warning');
                    }
                }
            }
        }

        function handleTextareaFocus() {
            this.placeholder = 'Type your thoughts here...';
        }

        function handleTextareaBlur() {
            this.placeholder = 'Share your thoughts...';
        }

        // Dynamic Comments Loading
        async function loadComments(postId) {
            try {
                const commentsContainer = document.getElementById('dynamic-comments-list');
                if (!commentsContainer) return;

                // Show loading state
                commentsContainer.innerHTML = '<div class="flex flex-col items-center justify-center py-16"><div class="w-14 h-14 rounded-full border-4 border-purple-200 border-t-purple-600 animate-spin mb-4"></div><p class="text-gray-500 dark:text-gray-400 text-lg">Loading comments...</p></div>';

                const response = await fetch(`/api/blogs/${postId}/comments-tree`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                commentsContainer.innerHTML = '';

                if (data.comments && data.comments.length > 0) {
                    data.comments.forEach(comment => {
                        const commentHtml = createCommentHTML(comment);
                        commentsContainer.appendChild(commentHtml);
                    });
                } else {
                    commentsContainer.innerHTML = '<div class="flex flex-col items-center justify-center py-16"><div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-2xl mb-4"><i class="ph-bold ph-chat-circle"></i></div><p class="text-gray-500 dark:text-gray-400 text-lg">No comments yet. Be the first to share your thoughts!</p></div>';
                }
            } catch (error) {
                console.error('Error loading comments:', error);
                const commentsContainer = document.getElementById('dynamic-comments-list');
                if (commentsContainer) {
                    commentsContainer.innerHTML = '<div class="flex flex-col items-center justify-center py-16"><div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center text-white text-2xl mb-4"><i class="ph-bold ph-warning-circle"></i></div><p class="text-gray-500 dark:text-gray-400 text-lg">Failed to load comments. Please try again later.</p></div>';
                }
            }
        }

        function createCommentHTML(comment) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-item';
            commentDiv.setAttribute('data-comment-id', comment.id);

            const isReply = comment.parent_id && comment.parent_id !== null;
            if (isReply) {
                commentDiv.classList.add('pl-8', 'sm:pl-12', 'border-l-2', 'border-gray-100', 'dark:border-gray-700');
            }

            commentDiv.innerHTML = `
            <div class="flex gap-5 p-6 rounded-2xl bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-800 transition-all duration-300">
                <div class="w-14 h-14 rounded-2xl flex-shrink-0 bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl shadow-lg">
                    ${(comment.author || 'A').charAt(0).toUpperCase()}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mb-3">
                        <span class="font-bold text-gray-900 dark:text-gray-100 text-lg">${escapeHtml(comment.author || 'Anonymous')}</span>
                        <span class="hidden sm:inline text-gray-400">•</span>
                        <span class="text-gray-500 dark:text-gray-400 text-base">${formatDate(comment.created_at)}</span>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 mb-5 text-lg leading-relaxed">${escapeHtml(comment.content || '')}</p>
                    <div class="flex items-center gap-4">
                        <button onclick="toggleCommentLike(${comment.id})" class="flex items-center gap-2 px-4 py-2 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors comment-like-btn">
                            <i class="ph-bold ph-heart text-xl"></i>
                            <span class="comment-like-count text-base font-medium">0</span>
                        </button>
                        <button onclick="replyToComment(${comment.id})" class="flex items-center gap-2 px-4 py-2 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-400">
                            <i class="ph-bold ph-arrow-u-up-left text-xl"></i>
                            <span class="text-base font-medium">Reply</span>
                        </button>
                    </div>
                </div>
            </div>
            ${comment.replies && comment.replies.length > 0 ?
                    `<div class="mt-6 space-y-4">${comment.replies.map(reply => createReplyHTML(reply)).join('')}</div>` :
                    ''
                }
        `;

            return commentDiv;
        }

        function createReplyHTML(reply) {
            return `
            <div class="comment-item pl-8 sm:pl-12 border-l-2 border-gray-100 dark:border-gray-700" data-comment-id="${reply.id}">
                <div class="flex gap-4 p-5 rounded-xl bg-gray-50 dark:bg-gray-800/30">
                    <div class="w-12 h-12 rounded-xl flex-shrink-0 bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-md">
                        ${(reply.author || 'A').charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 mb-2">
                            <span class="font-semibold text-gray-900 dark:text-gray-100 text-base">${escapeHtml(reply.author || 'Anonymous')}</span>
                            <span class="hidden sm:inline text-gray-400">•</span>
                            <span class="text-gray-500 dark:text-gray-400 text-sm">${formatDate(reply.created_at)}</span>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 mb-3 text-base leading-relaxed">${escapeHtml(reply.content || '')}</p>
                        <div class="flex items-center gap-3">
                            <button onclick="toggleCommentLike(${reply.id})" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors comment-like-btn">
                                <i class="ph-bold ph-heart text-lg"></i>
                                <span class="comment-like-count text-sm font-medium">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Just now';

            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = diffMs / (1000 * 60 * 60);

            if (diffHours < 1) {
                const diffMins = Math.floor(diffMs / (1000 * 60));
                return diffMins <= 1 ? 'Just now' : `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                const hours = Math.floor(diffHours);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(diffHours / 24);
                if (days < 7) {
                    return `${days} day${days > 1 ? 's' : ''} ago`;
                }
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Comment submission
        function openCommentModal() {
            const textarea = document.querySelector('.comment-textarea');
            const commentText = textarea ? textarea.value.trim() : '';

            if (!commentText) {
                showNotification('Please write a comment before submitting.', 'warning');
                if (textarea) textarea.focus();
                return;
            }

            // Store comment text and show modal
            window.pendingComment = commentText;

            // Simple inline modal
            const modal = createInlineModal();
            document.body.appendChild(modal);
        }

        function createInlineModal() {
            console.log('🎪 Creating inline modal with DEBUG features...');

            // Create modal with modern structure and proper ARIA attributes
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center p-4 animate-in fade-in duration-300';
            modal.style.zIndex = '9999'; // Higher z-index for proper layering
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('aria-labelledby', 'comment-modal-title');
            modal.setAttribute('data-comment-modal', 'true');

            console.log('✅ Modal element created with debug styles');

            // Create modal content with semantic HTML - EXTRA LARGE SIZE
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white dark:bg-gray-900 rounded-3xl shadow-2xl max-w-2xl w-full border-2 border-gray-100 dark:border-gray-800 transform animate-in slide-up duration-300 overflow-hidden';

            modalContent.innerHTML = `
            <!-- Modal Header - EXTRA LARGE -->
            <div class="relative px-8 py-6 border-b-2 border-gray-100 dark:border-gray-800">
                <div class="flex items-center justify-between">
                    <h2 id="comment-modal-title" class="text-5xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg">
                            <i class="ph-bold ph-chat-circle-dots text-white text-3xl"></i>
                        </div>
                        Add Your Comment
                    </h2>
                    <button class="modal-close-btn p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-all duration-200 group" aria-label="Close modal">
                        <i class="ph-bold ph-x text-gray-400 dark:text-gray-500 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-colors text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Body - EXTRA LARGE -->
            <div class="px-8 py-8">
                <form class="comment-form space-y-6">
                    <!-- Name Field - EXTRA LARGE -->
                    <div class="space-y-4">
                        <label for="comment-name-input" class="block text-2xl font-bold text-gray-700 dark:text-gray-300">
                            Name <span class="text-red-500 text-3xl">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none z-10">
                                <i class="ph-bold ph-user text-gray-400 dark:text-gray-500 text-2xl"></i>
                            </div>
                            <input
                                id="comment-name-input"
                                name="name"
                                type="text"
                                required
                                class="comment-name-input w-full pl-20 pr-6 py-8 border-2 border-gray-200 dark:border-gray-600 rounded-2xl focus:ring-4 focus:ring-purple-500 dark:focus:ring-purple-400 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 transition-all duration-200 text-2xl font-medium relative z-20"
                                placeholder="Enter your name"
                            >
                        </div>
                    </div>

                    <!-- Email Field - EXTRA LARGE -->
                    <div class="space-y-4">
                        <label for="comment-email-input" class="block text-2xl font-bold text-gray-700 dark:text-gray-300">
                            Email <span class="text-gray-400">(Optional)</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none z-10">
                                <i class="ph-bold ph-envelope text-gray-400 dark:text-gray-500 text-2xl"></i>
                            </div>
                            <input
                                id="comment-email-input"
                                name="email"
                                type="email"
                                class="comment-email-input w-full pl-20 pr-6 py-8 border-2 border-gray-200 dark:border-gray-600 rounded-2xl focus:ring-4 focus:ring-purple-500 dark:focus:ring-purple-400 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 transition-all duration-200 text-2xl font-medium relative z-20"
                                placeholder="your.email@example.com"
                            >
                        </div>
                        <p class="text-xl text-gray-500 dark:text-gray-400">Your email will not be published.</p>
                    </div>
                </form>
            </div>

            <!-- Modal Footer - EXTRA LARGE -->
            <div class="px-8 py-6 bg-gray-50 dark:bg-gray-800/50 border-t-2 border-gray-100 dark:border-gray-700">
                <div class="flex gap-4">
                    <button class="modal-cancel-btn flex-1 px-8 py-5 border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-2xl hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-300 dark:hover:border-gray-500 transition-all duration-200 font-bold text-2xl">
                        <span class="flex items-center justify-center gap-3">
                            <i class="ph-bold ph-x-circle text-3xl"></i>
                            <span>Cancel</span>
                        </span>
                    </button>
                    <button class="modal-submit-btn flex-1 px-8 py-5 bg-gradient-to-r from-purple-600 to-purple-700 dark:from-purple-500 dark:to-purple-600 text-white rounded-2xl hover:from-purple-700 hover:to-purple-800 dark:hover:from-purple-600 dark:hover:to-purple-700 transition-all duration-300 transform hover:scale-[1.02] font-bold text-2xl shadow-xl hover:shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <span class="flex items-center justify-center gap-3">
                            <i class="ph-bold ph-chat-circle-dots text-3xl"></i>
                            <span>Post Comment</span>
                        </span>
                    </button>
                </div>
            </div>
        `;

            // Assemble modal
            modal.appendChild(modalContent);

            // DEBUG: Event handlers replaced with direct attachment above

            // DEBUG: Add comprehensive click logging
            modal.addEventListener('click', (e) => {
                console.log('🎯 MODAL clicked:', {
                    target: e.target,
                    currentTarget: e.currentTarget,
                    targetClass: e.target.className,
                    targetTag: e.target.tagName,
                    path: e.composedPath().slice(0, 5)
                });
            });

            // DEBUG: Direct event listener attachment instead of delegation
            console.log('🔧 Attaching modal event listeners (DIRECT)...');

            // Close button - DIRECT
            const closeBtn = modalContent.querySelector('.modal-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    console.log('❌ Close button clicked (DIRECT)');
                    e.preventDefault();
                    e.stopPropagation();
                    closeCommentModal();
                });
                console.log('✅ Close button listener attached (DIRECT)');
            }

            // Cancel button - DIRECT
            const cancelBtn = modalContent.querySelector('.modal-cancel-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', (e) => {
                    console.log('🚫 Cancel button clicked (DIRECT)');
                    e.preventDefault();
                    e.stopPropagation();
                    closeCommentModal();
                });
                console.log('✅ Cancel button listener attached (DIRECT)');
            }

            // Submit button - DIRECT
            const submitBtn = modalContent.querySelector('.modal-submit-btn');
            if (submitBtn) {
                submitBtn.addEventListener('click', (e) => {
                    console.log('📤 Submit button clicked (DIRECT)');
                    e.preventDefault();
                    e.stopPropagation();
                    const name = document.getElementById('comment-name-input').value.trim();
                    const email = document.getElementById('comment-email-input').value.trim();
                    saveUserInfo(name, email).then(function () {
                        submitComment(name, email, window.pendingComment);
                    }).catch(function () {
                        submitComment(name, email, window.pendingComment);
                    });
                });
                console.log('✅ Submit button listener attached (DIRECT)');
            }

            // Overlay click - DIRECT
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    console.log('🌫️ Overlay clicked (DIRECT)');
                    closeCommentModal();
                }
            });
            console.log('✅ Overlay click listener attached (DIRECT)');

            // Form submission - DIRECT
            const form = modalContent.querySelector('.comment-form');
            if (form) {
                form.addEventListener('submit', (e) => {
                    console.log('📝 Form submitted (DIRECT)');
                    e.preventDefault();
                    const name = document.getElementById('comment-name-input').value.trim();
                    const email = document.getElementById('comment-email-input').value.trim();
                    saveUserInfo(name, email).then(function () {
                        submitComment(name, email, window.pendingComment);
                    }).catch(function () {
                        submitComment(name, email, window.pendingComment);
                    });
                });
                console.log('✅ Form submit listener attached (DIRECT)');
            }

            // Keyboard navigation - DIRECT
            modal.addEventListener('keydown', (e) => {
                console.log('⌨️ Key pressed:', e.key);
                if (e.key === 'Escape') {
                    console.log('🎪 Escape pressed');
                    closeCommentModal();
                }
            });
            console.log('✅ Keyboard listener attached (DIRECT)');

            // Focus management
            setTimeout(() => {
                const nameInput = modalContent.querySelector('.comment-name-input');
                if (nameInput) {
                    nameInput.focus();
                    // Scroll into view if needed
                    nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 150);

            console.log('🎪 Modal creation complete with DEBUG features');

            return modal;
        }

        function closeCommentModal() {
            const modal = document.querySelector('[data-comment-modal]');
            if (modal) {
                console.log('🔒 Closing modal (DEBUG version)...');

                // DEBUG: Log before closing
                console.log('Modal element:', modal);
                console.log('Modal style:', modal.style.cssText);

                // Animate out with smooth transition
                modal.classList.add('animate-out', 'fade-out', 'duration-300');
                modal.style.opacity = '0';
                modal.style.transform = 'scale(0.95) translateY(-10px)';

                // Remove after animation
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                        console.log('✅ Modal completely removed (DEBUG)');
                    }
                }, 300);
            }

            // Clean up pending comment
            delete window.pendingComment;
            console.log('🧹 Pending comment cleaned up');
        }

        // Reply functionality
        function replyToComment(commentId) {
            replyToCommentId = commentId;
            const textarea = document.querySelector('.comment-textarea');
            if (textarea) {
                textarea.placeholder = `Replying to comment...`;
                textarea.focus();
                showNotification('Replying to comment. Enter your reply and click "Post Comment".', 'info');
            }
        }

        // Like functionality
        async function toggleCommentLike(commentId) {
            try {
                // For now, just toggle UI state
                const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
                const likeBtn = commentItem.querySelector('.comment-like-btn');
                const likeIcon = likeBtn.querySelector('i');
                const likeCount = commentItem.querySelector('.comment-like-count');

                const isLiked = likeIcon.classList.contains('text-red-500');
                const currentCount = parseInt(likeCount.textContent) || 0;
                const newCount = isLiked ? currentCount - 1 : currentCount + 1;

                // Toggle visual state
                if (isLiked) {
                    likeIcon.classList.remove('text-red-500', 'ph-fill');
                    likeIcon.classList.add('ph-bold');
                } else {
                    likeIcon.classList.add('text-red-500', 'ph-fill');
                    likeIcon.classList.remove('ph-bold');
                }

                likeCount.textContent = newCount;

                // Store in localStorage for now (could be enhanced to call backend)
                const likedComments = JSON.parse(localStorage.getItem('likedComments') || '[]');
                if (isLiked) {
                    const index = likedComments.indexOf(commentId.toString());
                    if (index > -1) likedComments.splice(index, 1);
                } else {
                    likedComments.push(commentId.toString());
                }
                localStorage.setItem('likedComments', JSON.stringify(likedComments));

                showNotification(isLiked ? 'Comment unliked' : 'Comment liked', 'success');

            } catch (error) {
                console.error('Error toggling comment like:', error);
                showNotification('Failed to like comment. Please try again.', 'error');
            }
        }

        // Update comment count UI immediately
        function updateCommentCount(increment = true) {
            const countLarge = document.getElementById('comment-count-large');
            const countSmall = document.getElementById('comment-count-small');
            const countBadge = document.getElementById('comment-count-badge');

            // Get current count from badge (most reliable)
            let currentCount = 0;
            if (countBadge) {
                const text = countBadge.textContent;
                const match = text.match(/(\d+)/);
                if (match) currentCount = parseInt(match[1]);
            }

            const newCount = increment ? currentCount + 1 : Math.max(0, currentCount - 1);

            // Update all count elements
            if (countLarge) {
                countLarge.textContent = newCount + ' Comments';
            }
            if (countSmall) {
                countSmall.textContent = newCount;
            }
            if (countBadge) {
                countBadge.textContent = newCount + ' Comments';
            }

            console.log('📊 Comment count updated:', newCount);
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;

            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };

            notification.classList.add(...colors[type].split(' '));
            notification.textContent = message;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Auto remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Expand comment section (show full comment interface)
        window.expandCommentSection = function () {
            try {
                if (window.commentSystemState.expanded) {
                    return;
                }

                const collapsedSection = document.getElementById('comment-section-collapsed');
                const expandedSection = document.getElementById('comment-section-expanded');
                const textarea = expandedSection ? expandedSection.querySelector('.comment-textarea') : null;

                if (!collapsedSection || !expandedSection) {
                    console.error('Comment sections not found:', { collapsedSection, expandedSection });
                    return;
                }

                // Update global state
                window.commentSystemState.expanded = true;

                // Hide collapsed section with animation
                collapsedSection.style.opacity = '0';
                collapsedSection.style.transform = 'scale(0.95)';
                collapsedSection.style.pointerEvents = 'none';

                setTimeout(() => {
                    collapsedSection.classList.add('hidden');
                    collapsedSection.style.opacity = '';
                    collapsedSection.style.transform = '';
                    collapsedSection.style.pointerEvents = '';

                    // Show expanded section with animation
                    expandedSection.classList.remove('hidden');
                    expandedSection.style.opacity = '0';
                    expandedSection.style.transform = 'scale(0.95)';
                    expandedSection.style.pointerEvents = 'none';

                    setTimeout(() => {
                        expandedSection.style.opacity = '1';
                        expandedSection.style.transform = 'scale(1)';
                        expandedSection.style.transition = 'all 0.3s ease-out';
                        expandedSection.style.pointerEvents = '';

                        // Focus the textarea after animation
                        if (textarea) {
                            setTimeout(() => {
                                textarea.focus();
                            }, 300);
                        }
                    }, 50);
                }, 200);

                // Setup comment form after expansion
                setTimeout(() => {
                    setupCommentForm();
                }, 500);

            } catch (error) {
                console.error('Error expanding comment section:', error);
                // Fallback: force show expanded section
                const expandedSection = document.getElementById('comment-section-expanded');
                const collapsedSection = document.getElementById('comment-section-collapsed');
                if (expandedSection && collapsedSection) {
                    expandedSection.classList.remove('hidden');
                    collapsedSection.classList.add('hidden');
                    window.commentSystemState.expanded = true;
                }
            }
        };

        // Collapse comment section (hide full comment interface)
        window.collapseCommentSection = function () {
            const collapsedSection = document.getElementById('comment-section-collapsed');
            const expandedSection = document.getElementById('comment-section-expanded');

            if (collapsedSection && expandedSection) {
                // Hide expanded section with animation
                expandedSection.style.opacity = '0';
                expandedSection.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    expandedSection.classList.add('hidden');
                    expandedSection.style.opacity = '';
                    expandedSection.style.transform = '';

                    // Show collapsed section with animation
                    collapsedSection.classList.remove('hidden');
                    collapsedSection.style.opacity = '0';
                    collapsedSection.style.transform = 'scale(0.95)';

                    setTimeout(() => {
                        collapsedSection.style.opacity = '1';
                        collapsedSection.style.transform = 'scale(1)';
                        collapsedSection.style.transition = 'all 0.3s ease-out';
                    }, 50);
                }, 200);

                commentSectionExpanded = false;
            }
        };

        // Scroll to comments section and expand if needed
        function scrollToComments() {
            try {
                const commentsSection = document.getElementById('comments');

                if (commentsSection) {
                    commentsSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start',
                        inline: 'nearest'
                    });

                    // Expand comment section after scrolling
                    setTimeout(() => {
                        if (!window.commentSystemState.expanded) {
                            window.expandCommentSection();
                        } else {
                            // If already expanded, just focus the textarea
                            const textarea = document.querySelector('.comment-textarea');
                            if (textarea) {
                                textarea.focus();
                            }
                        }
                    }, 800);
                } else {
                    console.error('Comments section not found');
                    showNotification('Comments section not found.', 'error');
                }
            } catch (error) {
                console.error('Error in scrollToComments:', error);
                showNotification('Error scrolling to comments.', 'error');
            }
        }

        // Make functions global for button clicks
        window.loadComments = loadComments;
        window.openCommentModal = openCommentModal;
        window.closeCommentModal = closeCommentModal;
        window.submitComment = submitComment;
        window.toggleCommentLike = toggleCommentLike;
        window.replyToComment = replyToComment;
        window.expandCommentSection = expandCommentSection;
        window.collapseCommentSection = collapseCommentSection;
        window.scrollToComments = scrollToComments;
        window.updateCommentCount = updateCommentCount;

        // Global error handler for comment system
        window.addEventListener('error', function (e) {
            if (e.filename && e.filename.includes('template1-banner-image.html')) {
                console.error('Comment system error:', e.error);
                // Try to recover by re-initializing
                setTimeout(() => {
                    try {
                        attachImmediateEvents();
                    } catch (recoveryError) {
                        console.error('Recovery failed:', recoveryError);
                    }
                }, 1000);
            }
        });

        // Final fallback - ensure everything works
        window.addEventListener('load', function () {
            setTimeout(() => {
                if (typeof window.attachImmediateEvents === 'function') {
                    window.attachImmediateEvents();
                }
                if (!window.commentSystemState.initialized) {
                    const event = new Event('DOMContentLoaded');
                    document.dispatchEvent(event);
                }
            }, 100);
        });

        // Emergency function caller for inline onclick handlers
        window.emergencyFunctionCaller = function (functionName, ...args) {
            try {
                if (typeof window[functionName] === 'function') {
                    return window[functionName].apply(window, args);
                } else {
                    // Try to attach events first
                    if (typeof window.attachImmediateEvents === 'function') {
                        window.attachImmediateEvents();
                        // Try again after a brief delay
                        setTimeout(() => {
                            if (typeof window[functionName] === 'function') {
                                return window[functionName].apply(window, args);
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error in emergency function caller:', functionName, error);
            }
        };

        // Periodic fallback to ensure events are attached
        function periodicEventAttachment() {
            try {
                // Use global function if available
                if (typeof window.attachImmediateEvents === 'function') {
                    window.attachImmediateEvents();
                }

                // Additional safety checks
                const collapsedSection = document.getElementById('comment-section-collapsed');
                const scrollButtons = document.querySelectorAll('button[onclick*="scrollToComments"]');

                if (collapsedSection && !collapsedSection.hasAttribute('data-attached')) {
                    collapsedSection.setAttribute('data-attached', 'true');
                    collapsedSection.addEventListener('click', function (e) {
                        e.preventDefault();
                        if (typeof window.expandCommentSection === 'function') {
                            window.expandCommentSection();
                        }
                    });
                }

                scrollButtons.forEach(function (btn, index) {
                    if (!btn.hasAttribute('data-attached')) {
                        btn.setAttribute('data-attached', 'true');
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            if (typeof window.scrollToComments === 'function') {
                                window.scrollToComments();
                            }
                        });
                    }
                });

            } catch (error) {
                console.error('Error in periodic event attachment:', error);
            }
        }

        // Run periodic checks for first 30 seconds
        let periodicCheckCount = 0;
        const periodicCheckInterval = setInterval(function () {
            periodicCheckCount++;
            if (periodicCheckCount <= 30) { // 30 seconds
                periodicEventAttachment();
            } else {
                clearInterval(periodicCheckInterval);
            }
        }, 1000); // Every 1 second

        // Share modal functionality
        window.openShareModal = function () {
            const modal = document.getElementById('share-modal');
            if (modal) {
                modal.classList.add('show');
                document.addEventListener('keydown', handleEscapeKey);
            }
        };

        window.closeShareModal = function () {
            const modal = document.getElementById('share-modal');
            if (modal) {
                modal.classList.remove('show');
                document.removeEventListener('keydown', handleEscapeKey);
            }
        };

        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                closeShareModal();
            }
        }

        // Initialize modal event listeners
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('share-modal');
            const overlay = modal ? modal.querySelector('.share-modal__overlay') : null;
            const closeBtn = document.getElementById('share-modal-close');
            const copyBtn = document.getElementById('copy-link-btn');

            if (overlay) {
                // Close on overlay click
                overlay.addEventListener('click', closeShareModal);
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', closeShareModal);
            }

            if (copyBtn) {
                copyBtn.addEventListener('click', function () {
                    const url = window.location.href;
                    const originalText = copyBtn.querySelector('.btn-caption').textContent;

                    // Try modern clipboard API first
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(url).then(function () {
                            copyBtn.querySelector('.btn-caption').textContent = 'Copied!';
                            copyBtn.classList.add('success');
                            setTimeout(function () {
                                copyBtn.querySelector('.btn-caption').textContent = originalText;
                                copyBtn.classList.remove('success');
                            }, 2000);
                        }).catch(function (err) {
                            console.error('Failed to copy: ', err);
                            fallbackCopyTextToClipboard(url, copyBtn, originalText);
                        });
                    } else {
                        // Fallback for older browsers
                        fallbackCopyTextToClipboard(url, copyBtn, originalText);
                    }
                });
            }

            // Make copyLink function global for other buttons
            window.copyLink = function () {
                const url = window.location.href;
                const originalText = 'Copy Link'; // Default text for standalone button

                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(url).then(function () {
                        showNotification('Link copied to clipboard!', 'success');
                    }).catch(function (err) {
                        console.error('Failed to copy: ', err);
                        fallbackCopyTextToClipboard(url, null, originalText);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopyTextToClipboard(url, null, originalText);
                }
            };
        });

        function fallbackCopyTextToClipboard(text, button, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    button.querySelector('.btn-caption').textContent = 'Copied!';
                    button.classList.add('success');
                    setTimeout(function () {
                        button.querySelector('.btn-caption').textContent = originalText;
                        button.classList.remove('success');
                    }, 2000);
                } else {
                    showNotification('Failed to copy link. Please copy manually.', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                showNotification('Failed to copy link. Please copy manually.', 'error');
            }

            document.body.removeChild(textArea);
        }

        // Generate user identifier for likes
        function getUserIdentifier() {
            let identifier = localStorage.getItem('userIdentifier');
            if (!identifier) {
                // Create a simple identifier based on timestamp and random string
                identifier = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userIdentifier', identifier);
            }
            return identifier;
        }

        // Check like status on page load
        async function checkLikeStatus(postId) {
            try {
                const userIdentifier = getUserIdentifier();
                const response = await fetch(`/api/blogs/${postId}/likes/status?user_identifier=${encodeURIComponent(userIdentifier)}`);
                if (response.ok) {
                    const data = await response.json();
                    updateLikeUI(data.liked);
                }
            } catch (error) {
                console.error('Error checking like status:', error);
            }
        }

        // Update like UI based on status
        function updateLikeUI(isLiked) {
            const likeIcon = document.querySelector('.like-icon');
            if (likeIcon) {
                if (isLiked) {
                    likeIcon.classList.add('text-red-500', 'ph-fill');
                    likeIcon.classList.remove('ph-bold');
                } else {
                    likeIcon.classList.remove('text-red-500', 'ph-fill');
                    likeIcon.classList.add('ph-bold');
                }
            }
        }

        // Like functionality for post
        window.toggleLike = async function () {
            const likeSection = document.querySelector('.like-section');
            const likeIcon = document.querySelector('.like-icon');
            const likeCount = document.querySelector('.like-count');
            const postId = likeSection ? likeSection.dataset.postId : null;

            if (!postId) {
                showNotification('Post ID not found', 'error');
                return;
            }

            const userIdentifier = getUserIdentifier();
            const isCurrentlyLiked = likeIcon.classList.contains('text-red-500');

            try {
                let response;
                if (isCurrentlyLiked) {
                    // Unlike the post
                    response = await fetch(`/api/blogs/${postId}/likes?user_identifier=${encodeURIComponent(userIdentifier)}`, {
                        method: 'DELETE'
                    });
                } else {
                    // Like the post
                    response = await fetch(`/api/blogs/${postId}/likes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_identifier: userIdentifier
                        })
                    });
                }

                if (response.ok) {
                    const data = await response.json();

                    // Update UI based on server response
                    updateLikeUI(data.liked || false);

                    // Update count from server
                    likeCount.textContent = data.like_count || 0;

                    // Show notification
                    showNotification(isCurrentlyLiked ? 'Post unliked' : 'Post liked', 'success');
                } else {
                    const errorData = await response.json();
                    showNotification(errorData.detail || 'Failed to update like', 'error');
                }
            } catch (error) {
                console.error('Error toggling like:', error);
                showNotification('Failed to update like. Please try again.', 'error');
            }
        };

        // Share functions with diagnostic logging for article share buttons
        window.shareOnFacebook = function () {
            console.log('=== ARTICLE FACEBOOK SHARE DIAGNOSTIC ===');
            console.log('shareOnFacebook called from article share buttons');

            // Log scroll position and button context
            console.log('Scroll position:', {
                scrollY: window.scrollY,
                scrollX: window.scrollX,
                innerHeight: window.innerHeight,
                innerWidth: window.innerWidth
            });

            // Find and log the specific button that was clicked
            const facebookBtn = document.querySelector('button[onclick="shareOnFacebook()"]');
            if (facebookBtn) {
                const rect = facebookBtn.getBoundingClientRect();
                console.log('Facebook button position:', {
                    boundingRect: rect,
                    inViewport: rect.top >= 0 && rect.bottom <= window.innerHeight,
                    computedStyle: {
                        zIndex: window.getComputedStyle(facebookBtn).zIndex,
                        pointerEvents: window.getComputedStyle(facebookBtn).pointerEvents,
                        position: window.getComputedStyle(facebookBtn).position,
                        display: window.getComputedStyle(facebookBtn).display,
                        visibility: window.getComputedStyle(facebookBtn).visibility
                    }
                });
            }

            // Check for overlapping elements at current scroll position
            const elementsAtPoint = document.elementsFromPoint(window.innerWidth / 2, window.innerHeight / 2);
            console.log('Elements at center of viewport:', elementsAtPoint.map(el => ({
                tagName: el.tagName,
                id: el.id,
                className: el.className,
                zIndex: window.getComputedStyle(el).zIndex
            })));

            // Check footer and fixed elements
            const footer = document.querySelector('footer');
            if (footer) {
                const footerRect = footer.getBoundingClientRect();
                console.log('Footer position:', footerRect);
                console.log('Footer z-index:', window.getComputedStyle(footer).zIndex);
            }

            const fixedElements = document.querySelectorAll('[style*="position: fixed"], [style*="position:fixed"]');
            fixedElements.forEach((el, index) => {
                const rect = el.getBoundingClientRect();
                console.log(`Fixed element ${index}:`, {
                    element: el,
                    tagName: el.tagName,
                    id: el.id,
                    className: el.className,
                    boundingRect: rect,
                    zIndex: window.getComputedStyle(el).zIndex,
                    isVisible: rect.top < window.innerHeight && rect.bottom > 0
                });
            });

            console.log('=== END FACEBOOK DIAGNOSTIC ===');

            // Execute the share
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}&t=${title}`;
            window.open(shareUrl, 'facebook-share', 'width=600,height=400');
        };

        window.shareOnTelegram = function () {
            console.log('=== ARTICLE TELEGRAM SHARE DIAGNOSTIC ===');
            console.log('shareOnTelegram called from article share buttons');

            console.log('Scroll position:', { scrollY: window.scrollY, innerHeight: window.innerHeight });

            const telegramBtn = document.querySelector('button[onclick="shareOnTelegram()"]');
            if (telegramBtn) {
                const rect = telegramBtn.getBoundingClientRect();
                console.log('Telegram button position:', {
                    boundingRect: rect,
                    inViewport: rect.top >= 0 && rect.bottom <= window.innerHeight,
                    zIndex: window.getComputedStyle(telegramBtn).zIndex,
                    pointerEvents: window.getComputedStyle(telegramBtn).pointerEvents
                });
            }

            console.log('=== END TELEGRAM DIAGNOSTIC ===');

            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(document.title);
            const shareUrl = `https://t.me/share/url?url=${url}&text=${text}`;
            window.open(shareUrl, 'telegram-share', 'width=600,height=400');
        };

        window.shareOnReddit = function () {
            console.log('=== ARTICLE REDDIT SHARE DIAGNOSTIC ===');
            console.log('shareOnReddit called from article share buttons');

            console.log('Scroll position:', { scrollY: window.scrollY, innerHeight: window.innerHeight });

            const redditBtn = document.querySelector('button[onclick="shareOnReddit()"]');
            if (redditBtn) {
                const rect = redditBtn.getBoundingClientRect();
                console.log('Reddit button position:', {
                    boundingRect: rect,
                    inViewport: rect.top >= 0 && rect.bottom <= window.innerHeight,
                    zIndex: window.getComputedStyle(redditBtn).zIndex,
                    pointerEvents: window.getComputedStyle(redditBtn).pointerEvents
                });
            }

            console.log('=== END REDDIT DIAGNOSTIC ===');

            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            const shareUrl = `https://www.reddit.com/submit?url=${url}&title=${title}`;
            window.open(shareUrl, 'reddit-share', 'width=600,height=400');
        };

        window.shareOnWhatsApp = function () {
            console.log('=== ARTICLE WHATSAPP SHARE DIAGNOSTIC ===');
            console.log('shareOnWhatsApp called from article share buttons');

            console.log('Scroll position:', { scrollY: window.scrollY, innerHeight: window.innerHeight });

            const whatsappBtn = document.querySelector('button[onclick="shareOnWhatsApp()"]');
            if (whatsappBtn) {
                const rect = whatsappBtn.getBoundingClientRect();
                console.log('WhatsApp button position:', {
                    boundingRect: rect,
                    inViewport: rect.top >= 0 && rect.bottom <= window.innerHeight,
                    zIndex: window.getComputedStyle(whatsappBtn).zIndex,
                    pointerEvents: window.getComputedStyle(whatsappBtn).pointerEvents
                });
            }

            console.log('=== END WHATSAPP DIAGNOSTIC ===');

            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(document.title + ' - ' + window.location.href);
            const shareUrl = `https://wa.me/?text=${text}`;
            window.open(shareUrl, 'whatsapp-share', 'width=600,height=400');
        };

        // Follow modal functionality (basic implementation)
        window.openFollowModal = function () {
            alert('Follow functionality coming soon!');
        };

        // =====================================================
        // TEMPORAL USER API INTEGRATION
        // =====================================================

        // Device fingerprinting for user identification
        let cachedFingerprint = null;

        async function getFingerprint() {
            if (cachedFingerprint) return cachedFingerprint;

            const components = [];
            components.push(navigator.userAgent);
            components.push(navigator.language || navigator.languages?.join(','));
            components.push(navigator.platform);
            components.push(navigator.hardwareConcurrency || 'unknown');
            components.push(navigator.deviceMemory || 'unknown');
            components.push(navigator.maxTouchPoints || 0);
            components.push(screen.width + 'x' + screen.height);
            components.push(screen.colorDepth);
            components.push(screen.pixelDepth);
            components.push(window.devicePixelRatio || 1);
            components.push(new Date().getTimezoneOffset());
            components.push(Intl.DateTimeFormat().resolvedOptions().timeZone);

            // Canvas fingerprint
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('FingerprintTest123', 2, 2);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillRect(100, 5, 80, 20);
                ctx.fillStyle = '#f60';
                ctx.fillText('ExtendedFingerprint', 4, 45);
                ctx.strokeStyle = 'rgb(120, 180, 0)';
                ctx.strokeRect(2, 50, 150, 30);
                components.push(canvas.toDataURL());
            } catch (e) {
                components.push('canvas-error');
            }

            // WebGL fingerprint
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (gl) {
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        components.push(gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL));
                        components.push(gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL));
                    }
                    components.push(gl.getParameter(gl.VERSION));
                    components.push(gl.getParameter(gl.SHADING_LANGUAGE_VERSION));
                }
            } catch (e) {
                components.push('webgl-error');
            }

            // Audio fingerprint
            try {
                const audio = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audio.createOscillator();
                const analyser = audio.createAnalyser();
                const gain = audio.createGain();
                osc.connect(gain);
                gain.connect(analyser);
                analyser.connect(audio.destination);
                osc.frequency.value = 1000;
                osc.type = 'sine';
                const buf = new Float32Array(analyser.frequencyBinCount);
                analyser.getFloatFrequencyData(buf);
                let hash = 0;
                for (let i = 0; i < buf.length; i++) hash += Math.abs(buf[i]);
                components.push(hash.toString());
                audio.close();
            } catch (e) {
                components.push('audio-error');
            }

            // Session storage check
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
                components.push('sessionStorage:true');
            } catch (e) {
                components.push('sessionStorage:false');
            }

            components.push('cookies:' + navigator.cookieEnabled);
            components.push('doNotTrack:' + navigator.doNotTrack);
            components.push('onLine:' + navigator.onLine);

            // Hash all components
            let hash = 0;
            const str = components.join('|');
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            cachedFingerprint = Math.abs(hash).toString(36);
            return cachedFingerprint;
        }

        // Save user info to temporal users API
        async function saveUserInfo(name, email) {
            const fingerprint = await getFingerprint();

            const deviceInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenResolution: screen.width + 'x' + screen.height,
                colorDepth: screen.colorDepth,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                hardwareConcurrency: navigator.hardwareConcurrency,
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack,
                onLine: navigator.onLine
            };

            try {
                const response = await fetch('/api/blogs/temporal-users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fingerprint: fingerprint,
                        name: name,
                        email: email,
                        device_info: deviceInfo
                    })
                });

                if (!response.ok && response.status !== 409) {
                    console.error('Failed to save user info:', response.status);
                }
            } catch (error) {
                console.error('Error saving user info:', error);
            }
        }

        // Get user info from temporal users API
        async function getUserInfo() {
            const fingerprint = await getFingerprint();

            try {
                const response = await fetch('/api/blogs/temporal-users/' + encodeURIComponent(fingerprint));

                if (response.status === 404) {
                    return null; // User not found
                }

                if (!response.ok) {
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error('Error getting user info:', error);
                return null;
            }
        }

        // Modified openCommentModal - checks for existing user first
        async function openCommentModal() {
            const textarea = document.querySelector('.comment-textarea');
            const commentText = textarea ? textarea.value.trim() : '';

            if (!commentText) {
                showNotification('Please write a comment before submitting.', 'warning');
                if (textarea) textarea.focus();
                return;
            }

            // Store comment text
            window.pendingComment = commentText;

            // Check if user already exists
            const userInfo = await getUserInfo();

            if (userInfo) {
                // User is known, submit immediately without showing modal
                console.log('Known user detected:', userInfo.name);
                submitComment(userInfo.name, userInfo.email, commentText);
            } else {
                // New user, show modal to collect name/email
                const modal = createInlineModal();
                document.body.appendChild(modal);
            }
        }

        // Modified submitComment - accepts name, email, content parameters
        async function submitComment(name, email, content) {
            if (!name) {
                showNotification('Please enter your name.', 'warning');
                return;
            }

            if (!content) {
                showNotification('No comment content found.', 'error');
                return;
            }

            try {
                // Show loading state
                const submitBtn = document.querySelector('button[onclick="submitComment()"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Posting...';
                    submitBtn.disabled = true;
                }

                const commentData = {
                    author_name: name,
                    author_email: email || null,
                    content: content,
                    parent_id: replyToCommentId
                };

                const response = await fetch(`/api/blogs/${currentPostId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commentData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Update comment count immediately
                updateCommentCount(true);

                showNotification('Comment submitted successfully! It will be visible after moderation.', 'success');

                // Clear form and close modal
                const textarea = document.querySelector('.comment-textarea');
                if (textarea) {
                    textarea.value = '';
                    textarea.style.height = 'auto';
                    textarea.style.height = '120px';
                }
                closeCommentModal();

                // Reload comments
                setTimeout(() => {
                    loadComments(currentPostId);
                }, 1000);

            } catch (error) {
                console.error('Error submitting comment:', error);
                showNotification('Failed to submit comment. Please try again.', 'error');
            } finally {
                // Reset button state
                const submitBtn = document.querySelector('button[onclick="submitComment()"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Post Comment';
                    submitBtn.disabled = false;
                }
            }
        }

    })();

    // Newsletter subscription function
    async function subscribeNewsletter(event) {
        event.preventDefault();

        const form = event.target;
        const emailInput = document.getElementById('newsletterEmail');
        const submitBtn = document.getElementById('newsletterSubmitBtn');
        const messageDiv = document.getElementById('newsletterMessage');
        const email = emailInput.value.trim();

        if (!email) {
            showNewsletterMessage('Please enter your email address', 'error');
            return;
        }

        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.textContent = 'Subscribing...';
        messageDiv.classList.add('hidden');

        try {
            const formData = new FormData();
            formData.append('name', email.split('@')[0]); // Use email prefix as name
            formData.append('email', email);

            const response = await fetch('/api/newsletter/subscribe', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success || response.ok) {
                showNewsletterMessage('🎉 Thanks for subscribing! Check your email for confirmation.', 'success');
                emailInput.value = '';

                // Keep success message visible
                setTimeout(() => {
                    submitBtn.textContent = 'Subscribe';
                    submitBtn.disabled = false;
                }, 2000);
            } else {
                showNewsletterMessage(data.message || 'Subscription failed. Please try again.', 'error');
                submitBtn.textContent = 'Subscribe';
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Newsletter subscription error:', error);
            showNewsletterMessage('An error occurred. Please try again later.', 'error');
            submitBtn.textContent = 'Subscribe';
            submitBtn.disabled = false;
        }
    }

    function showNewsletterMessage(message, type) {
        const messageDiv = document.getElementById('newsletterMessage');
        messageDiv.textContent = message;
        messageDiv.classList.remove('hidden', 'text-green-600', 'text-red-600', 'dark:text-green-400', 'dark:text-red-400');

        if (type === 'success') {
            messageDiv.classList.add('text-green-600', 'dark:text-green-400');
        } else {
            messageDiv.classList.add('text-red-600', 'dark:text-red-400');
        }
    }

    // Nuclear Cleanup: Remove ANY structural section that isn't tagged as part of the primary template
    (function cleanupDuplicatesNuclear() {
        const structuralSelectors = [
            '#blog-hero-section',
            '#blog-engagement-bar',
            '#blog-comments-section',
            'aside',
            'nav',
            'footer',
            '#comments'
        ];

        structuralSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                // If it doesn't have our template tag, it's a duplicate from the DB content
                if (el.getAttribute('data-is-template') !== 'true') {
                    console.warn('[Nuclear Cleanup] Removing duplicated section:', selector);
                    el.remove();
                }
            });
        });
    })();
</script>
{% endblock %}