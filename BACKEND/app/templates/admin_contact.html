<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - NekwasaR</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--stroke-elements);
        }
        .messages-grid {
            display: grid;
            gap: 1rem;
        }
        .message-card {
            background: var(--base);
            border: 1px solid var(--stroke-elements);
            border-radius: var(--_radius-xl);
            padding: 1.5rem;
            transition: all 0.3s var(--_animbezier);
            cursor: pointer;
        }
        .message-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .message-card.unread {
            border-left: 4px solid var(--accent);
            background: linear-gradient(90deg, rgba(3, 0, 14, 0.05) 0%, var(--base) 20%);
        }
        .message-card.read {
            opacity: 0.7;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .message-sender {
            font-weight: 700;
            color: var(--t-bright);
        }
        .message-date {
            font-size: 1.2rem;
            color: var(--t-muted);
        }
        .message-email {
            color: var(--t-medium);
            margin-bottom: 0.5rem;
        }
        .message-content {
            color: var(--t-medium);
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        .message-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        .btn-small {
            padding: 0.5rem 1rem;
            border: 1px solid var(--stroke-elements);
            background: var(--base);
            color: var(--t-bright);
            border-radius: var(--_radius-m);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s var(--_animbezier);
        }
        .btn-small:hover {
            background: var(--base-tint);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--secondary));
            color: var(--t-opp-bright);
            border: none;
        }
        .stats-bar {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--base-tint);
            border-radius: var(--_radius-xl);
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--t-accent);
        }
        .stat-label {
            font-size: 1.2rem;
            color: var(--t-medium);
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--t-medium);
        }
        .logout-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--stroke-controls);
            color: var(--t-bright);
            border-radius: var(--_radius-m);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Contact Messages</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="loading">Loading statistics...</div>
        </div>

        <div id="messagesContainer">
            <div class="loading">Loading messages...</div>
        </div>
    </div>

    <script>
        let allMessages = [];

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/admin';
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('token');
                    window.location.href = '/admin';
                }
            } catch (error) {
                localStorage.removeItem('token');
                window.location.href = '/admin';
            }
        }

        async function loadMessages() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch('/api/contacts/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    allMessages = await response.json();
                    renderMessages();
                    updateStats();
                } else if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/admin';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');

            if (allMessages.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--t-medium);">No messages yet.</p>';
                return;
            }

            container.innerHTML = `
                <div class="messages-grid">
                    ${allMessages.map(msg => `
                        <div class="message-card ${msg.is_read ? 'read' : 'unread'}" onclick="toggleMessage(this)">
                            <div class="message-header">
                                <div class="message-sender">${escapeHtml(msg.name)}</div>
                                <div class="message-date">${new Date(msg.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="message-email">${escapeHtml(msg.email)}</div>
                            <div class="message-content">${escapeHtml(msg.message)}</div>
                            <div class="message-actions">
                                <button class="btn-small ${msg.is_read ? '' : 'btn-primary'}" onclick="markAsRead(${msg.id}, event)">
                                    ${msg.is_read ? 'Mark Unread' : 'Mark Read'}
                                </button>
                                <button class="btn-small" onclick="deleteMessage(${msg.id}, event)" style="color: #ff6b6b;">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateStats() {
            const total = allMessages.length;
            const unread = allMessages.filter(msg => !msg.is_read).length;
            const read = total - unread;

            document.getElementById('statsBar').innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" style="color: var(--accent);">${unread}</div>
                    <div class="stat-label">Unread</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${read}</div>
                    <div class="stat-label">Read</div>
                </div>
            `;
        }

        async function markAsRead(messageId, event) {
            event.stopPropagation();
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/api/contacts/${messageId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Update local data
                    const message = allMessages.find(msg => msg.id === messageId);
                    if (message) {
                        message.is_read = !message.is_read;
                        renderMessages();
                        updateStats();
                    }
                }
            } catch (error) {
                console.error('Error updating message:', error);
            }
        }

        async function deleteMessage(messageId, event) {
            event.stopPropagation();
            if (!confirm('Are you sure you want to delete this message?')) return;

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/api/contacts/${messageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Remove from local data
                    allMessages = allMessages.filter(msg => msg.id !== messageId);
                    renderMessages();
                    updateStats();
                }
            } catch (error) {
                console.error('Error deleting message:', error);
            }
        }

        function toggleMessage(card) {
            card.classList.toggle('expanded');
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/admin';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        checkAuth();
        loadMessages();

        // Auto refresh every 30 seconds
        setInterval(loadMessages, 30000);
    </script>
</body>
</html>