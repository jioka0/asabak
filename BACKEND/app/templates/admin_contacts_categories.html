<!-- Contact Message Categories -->
<div class="contacts-categories">
    <!-- Categories Header -->
    <div class="categories-header">
        <div class="header-content">
            <h2>Message Categories</h2>
            <p>Organize and manage message categories for better workflow</p>
        </div>
        <div class="header-actions">
            <button class="action-btn primary" id="createCategoryBtn">
                <i class="ph-bold ph-plus"></i>
                Create Category
            </button>
            <button class="action-btn secondary" id="reorderCategoriesBtn">
                <i class="ph-bold ph-arrows-out"></i>
                Reorder
            </button>
        </div>
    </div>

    <!-- Categories Stats -->
    <div class="categories-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="ph-bold ph-tag"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalCategories">0</div>
                <div class="stat-label">Total Categories</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="ph-bold ph-envelope"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="categorizedMessages">0</div>
                <div class="stat-label">Categorized Messages</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="ph-bold ph-funnel"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="autoCategorizationRate">0%</div>
                <div class="stat-label">Auto-Categorization Rate</div>
            </div>
        </div>
    </div>

    <!-- Categories List -->
    <div class="categories-list" id="categoriesList">
        <!-- Categories will be populated here -->
    </div>

    <!-- Category Editor Modal -->
    <div class="modal-overlay" id="categoryModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Create Category</h3>
                <button class="modal-close" id="modalClose">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="form-group">
                        <label for="categoryName">Category Name</label>
                        <input type="text" id="categoryName" placeholder="e.g., Support, Sales, General" required>
                    </div>
                    <div class="form-group">
                        <label for="categoryDescription">Description</label>
                        <textarea id="categoryDescription" rows="3" placeholder="Brief description of this category"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="categoryColor">Color</label>
                        <div class="color-picker">
                            <div class="color-options" id="colorOptions">
                                <div class="color-option" data-color="#3b82f6" style="background: #3b82f6;"></div>
                                <div class="color-option" data-color="#ef4444" style="background: #ef4444;"></div>
                                <div class="color-option" data-color="#10b981" style="background: #10b981;"></div>
                                <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;"></div>
                                <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;"></div>
                                <div class="color-option" data-color="#06b6d4" style="background: #06b6d4;"></div>
                                <div class="color-option" data-color="#84cc16" style="background: #84cc16;"></div>
                                <div class="color-option" data-color="#f97316" style="background: #f97316;"></div>
                            </div>
                            <input type="color" id="customColor" style="display: none;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="categoryIcon">Icon</label>
                        <div class="icon-picker">
                            <div class="icon-options" id="iconOptions">
                                <div class="icon-option" data-icon="ph-question">
                                    <i class="ph-bold ph-question"></i>
                                </div>
                                <div class="icon-option" data-icon="ph-shopping-cart">
                                    <i class="ph-bold ph-shopping-cart"></i>
                                </div>
                                <div class="icon-option" data-icon="ph-gear">
                                    <i class="ph-bold ph-gear"></i>
                                </div>
                                <div class="icon-option" data-icon="ph-chat">
                                    <i class="ph-bold ph-chat"></i>
                                </div>
                                <div class="icon-option" data-icon="ph-lightbulb">
                                    <i class="ph-bold ph-lightbulb"></i>
                                </div>
                                <div class="icon-option" data-icon="ph-warning">
                                    <i class="ph-bold ph-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="autoRules">Auto-Categorization Rules</label>
                        <div class="rules-builder" id="rulesBuilder">
                            <div class="rule-item">
                                <select class="rule-field">
                                    <option value="subject">Subject contains</option>
                                    <option value="body">Body contains</option>
                                    <option value="sender">Sender email contains</option>
                                    <option value="sender_domain">Sender domain is</option>
                                </select>
                                <input type="text" class="rule-value" placeholder="Enter keywords or patterns">
                                <button type="button" class="remove-rule-btn">
                                    <i class="ph-bold ph-minus"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="add-rule-btn" id="addRuleBtn">
                            <i class="ph-bold ph-plus"></i>
                            Add Rule
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="assignedUsers">Auto-Assign To</label>
                        <select id="assignedUsers" multiple>
                            <!-- Users will be populated here -->
                        </select>
                        <small class="form-help">Hold Ctrl/Cmd to select multiple users</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="modalCancel">Cancel</button>
                <button class="btn primary" id="modalSave">Save Category</button>
            </div>
        </div>
    </div>
</div>

<style>
    .contacts-categories {
        padding: 2rem;
    }

    /* Categories Header */
    .categories-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--admin-border);
    }

    .header-content h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--admin-text-primary);
        margin: 0 0 0.5rem 0;
    }

    .header-content p {
        color: var(--admin-text-secondary);
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-surface);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .action-btn:hover {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    .action-btn.primary {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    .action-btn.secondary {
        background: var(--admin-secondary);
        color: white;
        border-color: var(--admin-secondary);
    }

    /* Categories Stats */
    .categories-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--admin-surface);
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-lg);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--admin-radius-md);
        background: var(--admin-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--admin-text-primary);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--admin-text-secondary);
    }

    /* Categories List */
    .categories-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .category-item {
        background: var(--admin-surface);
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-lg);
        padding: 1.5rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .category-item:hover {
        box-shadow: var(--admin-shadow-lg);
        transform: translateY(-2px);
    }

    .category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .category-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }

    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--admin-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .category-details {
        flex: 1;
    }

    .category-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--admin-text-primary);
        margin-bottom: 0.25rem;
    }

    .category-description {
        font-size: 0.875rem;
        color: var(--admin-text-secondary);
    }

    .category-actions {
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .category-item:hover .category-actions {
        opacity: 1;
    }

    .category-action-btn {
        padding: 0.375rem;
        border: none;
        background: none;
        color: var(--admin-text-secondary);
        cursor: pointer;
        border-radius: var(--admin-radius-sm);
        transition: all 0.2s ease;
    }

    .category-action-btn:hover {
        background: var(--admin-border);
        color: var(--admin-text-primary);
    }

    .category-action-btn.edit:hover {
        background: var(--admin-primary);
        color: white;
    }

    .category-action-btn.delete:hover {
        background: var(--admin-error);
        color: white;
    }

    .category-stats {
        display: flex;
        gap: 2rem;
        margin-bottom: 1rem;
    }

    .category-stat {
        text-align: center;
    }

    .category-stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--admin-text-primary);
        display: block;
    }

    .category-stat-label {
        font-size: 0.75rem;
        color: var(--admin-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .category-rules {
        font-size: 0.875rem;
        color: var(--admin-text-secondary);
    }

    .category-rule {
        display: inline-block;
        background: var(--admin-background);
        padding: 0.25rem 0.5rem;
        border-radius: var(--admin-radius-sm);
        margin-right: 0.5rem;
        margin-bottom: 0.25rem;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--admin-surface);
        border-radius: var(--admin-radius-lg);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--admin-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--admin-text-primary);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--admin-text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: var(--admin-radius-sm);
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: var(--admin-border);
        color: var(--admin-text-primary);
    }

    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--admin-text-primary);
        margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-background);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--admin-primary);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    .form-group select[multiple] {
        min-height: 120px;
    }

    .form-help {
        display: block;
        font-size: 0.75rem;
        color: var(--admin-text-secondary);
        margin-top: 0.25rem;
    }

    /* Color Picker */
    .color-picker {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .color-options {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .color-option {
        width: 40px;
        height: 40px;
        border-radius: var(--admin-radius-md);
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s ease;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: var(--admin-text-primary);
        box-shadow: 0 0 0 2px var(--admin-background);
    }

    /* Icon Picker */
    .icon-picker {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .icon-options {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 0.5rem;
    }

    .icon-option {
        width: 40px;
        height: 40px;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--admin-text-secondary);
        transition: all 0.2s ease;
    }

    .icon-option:hover {
        background: var(--admin-background);
        color: var(--admin-text-primary);
    }

    .icon-option.selected {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    /* Rules Builder */
    .rules-builder {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .rule-item {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .rule-field,
    .rule-value {
        padding: 0.5rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-background);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
    }

    .rule-field {
        min-width: 140px;
    }

    .rule-value {
        flex: 1;
    }

    .remove-rule-btn {
        padding: 0.5rem;
        border: none;
        background: var(--admin-error);
        color: white;
        border-radius: var(--admin-radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .remove-rule-btn:hover {
        background: #dc2626;
    }

    .add-rule-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-background);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        align-self: flex-start;
    }

    .add-rule-btn:hover {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--admin-border);
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-surface);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn:hover {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    .btn.secondary {
        background: var(--admin-secondary);
        color: white;
        border-color: var(--admin-secondary);
    }

    .btn.primary {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        text-align: center;
        color: var(--admin-text-secondary);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: var(--admin-text-primary);
    }

    .empty-state p {
        font-size: 0.875rem;
        margin-bottom: 2rem;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .color-options {
            grid-template-columns: repeat(8, 1fr);
        }

        .icon-options {
            grid-template-columns: repeat(8, 1fr);
        }
    }

    @media (max-width: 768px) {
        .contacts-categories {
            padding: 1rem;
        }

        .categories-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .header-actions {
            width: 100%;
            justify-content: center;
        }

        .categories-stats {
            grid-template-columns: 1fr;
        }

        .category-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .category-actions {
            opacity: 1;
        }

        .modal-content {
            width: 95%;
            margin: 1rem;
        }

        .modal-footer {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }

        .color-options {
            grid-template-columns: repeat(4, 1fr);
        }

        .icon-options {
            grid-template-columns: repeat(4, 1fr);
        }

        .rule-item {
            flex-direction: column;
            gap: 0.5rem;
        }

        .rule-field,
        .rule-value {
            width: 100%;
        }
    }
</style>

<script>
    // Contact Message Categories Management
    let currentCategoryId = null;
    let selectedColor = '#3b82f6';
    let selectedIcon = 'ph-question';

    function initContactsCategories() {
        loadCategoriesData();
        setupEventListeners();
    }

    async function loadCategoriesData() {
        try {
            const response = await fetch('/api/admin/contacts/categories');
            if (response.ok) {
                const data = await response.json();
                updateCategoriesStats(data.stats);
                updateCategoriesList(data.categories);
                updateUsersList(data.users);
            }
        } catch (error) {
            console.error('Error loading categories data:', error);
        }
    }

    function updateCategoriesStats(stats) {
        document.getElementById('totalCategories').textContent = stats.total || 0;
        document.getElementById('categorizedMessages').textContent = stats.categorized || 0;
        document.getElementById('autoCategorizationRate').textContent = stats.autoRate ? stats.autoRate + '%' : '0%';
    }

    function updateCategoriesList(categories) {
        const container = document.getElementById('categoriesList');

        if (!categories || categories.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="ph-bold ph-tag"></i>
                    <h3>No categories yet</h3>
                    <p>Create categories to organize your messages and improve workflow efficiency.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = categories.map(category => `
            <div class="category-item" onclick="editCategory(${category.id})">
                <div class="category-header">
                    <div class="category-info">
                        <div class="category-icon" style="background: ${category.color};">
                            <i class="ph-bold ${category.icon}"></i>
                        </div>
                        <div class="category-details">
                            <div class="category-name">${category.name}</div>
                            <div class="category-description">${category.description || 'No description'}</div>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="category-action-btn edit" onclick="editCategory(${category.id}); event.stopPropagation();" title="Edit category">
                            <i class="ph-bold ph-pencil"></i>
                        </button>
                        <button class="category-action-btn delete" onclick="deleteCategory(${category.id}); event.stopPropagation();" title="Delete category">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="category-stats">
                    <div class="category-stat">
                        <span class="category-stat-value">${category.messageCount || 0}</span>
                        <span class="category-stat-label">Messages</span>
                    </div>
                    <div class="category-stat">
                        <span class="category-stat-value">${category.autoAssigned || 0}</span>
                        <span class="category-stat-label">Auto-Assigned</span>
                    </div>
                    <div class="category-stat">
                        <span class="category-stat-value">${category.avgResponseTime || '--'}</span>
                        <span class="category-stat-label">Avg Response</span>
                    </div>
                </div>
                ${category.rules && category.rules.length > 0 ? `
                    <div class="category-rules">
                        ${category.rules.slice(0, 3).map(rule => `<span class="category-rule">${rule.field}: ${rule.value}</span>`).join('')}
                        ${category.rules.length > 3 ? `<span class="category-rule">+${category.rules.length - 3} more</span>` : ''}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    function updateUsersList(users) {
        const select = document.getElementById('assignedUsers');
        select.innerHTML = '';

        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name;
            select.appendChild(option);
        });
    }

    function setupEventListeners() {
        // Create category button
        document.getElementById('createCategoryBtn').addEventListener('click', () => {
            openCategoryModal();
        });

        // Reorder categories button
        document.getElementById('reorderCategoriesBtn').addEventListener('click', () => {
            toggleReorderMode();
        });

        // Modal events
        document.getElementById('modalClose').addEventListener('click', closeCategoryModal);
        document.getElementById('modalCancel').addEventListener('click', closeCategoryModal);
        document.getElementById('modalSave').addEventListener('click', saveCategory);
        document.getElementById('addRuleBtn').addEventListener('click', addRule);

        // Color picker
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', () => {
                selectColor(option.dataset.color);
            });
        });

        // Icon picker
        document.querySelectorAll('.icon-option').forEach(option => {
            option.addEventListener('click', () => {
                selectIcon(option.dataset.icon);
            });
        });

        // Close modal on overlay click
        document.getElementById('categoryModal').addEventListener('click', (e) => {
            if (e.target.id === 'categoryModal') {
                closeCategoryModal();
            }
        });
    }

    function openCategoryModal(categoryId = null) {
        currentCategoryId = categoryId;
        const modal = document.getElementById('categoryModal');
        const title = document.getElementById('modalTitle');
        const form = document.getElementById('categoryForm');

        if (categoryId) {
            title.textContent = 'Edit Category';
            // Load existing category data
            loadCategoryData(categoryId);
        } else {
            title.textContent = 'Create Category';
            form.reset();
            resetColorSelection();
            resetIconSelection();
            clearRules();
        }

        modal.style.display = 'flex';
    }

    function closeCategoryModal() {
        const modal = document.getElementById('categoryModal');
        modal.style.display = 'none';
        currentCategoryId = null;
        document.getElementById('categoryForm').reset();
    }

    async function loadCategoryData(categoryId) {
        try {
            const response = await fetch(`/api/admin/contacts/category/${categoryId}`);
            if (response.ok) {
                const category = await response.json();

                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryDescription').value = category.description || '';
                selectColor(category.color);
                selectIcon(category.icon);

                // Load rules
                clearRules();
                if (category.rules) {
                    category.rules.forEach(rule => addRuleFromData(rule));
                }

                // Load assigned users
                if (category.assignedUsers) {
                    const select = document.getElementById('assignedUsers');
                    Array.from(select.options).forEach(option => {
                        option.selected = category.assignedUsers.includes(parseInt(option.value));
                    });
                }
            }
        } catch (error) {
            console.error('Error loading category:', error);
        }
    }

    function selectColor(color) {
        selectedColor = color;

        // Update UI
        document.querySelectorAll('.color-option').forEach(option => {
            option.classList.remove('selected');
        });

        const selectedOption = document.querySelector(`[data-color="${color}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
    }

    function selectIcon(icon) {
        selectedIcon = icon;

        // Update UI
        document.querySelectorAll('.icon-option').forEach(option => {
            option.classList.remove('selected');
        });

        const selectedOption = document.querySelector(`[data-icon="${icon}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
    }

    function resetColorSelection() {
        selectedColor = '#3b82f6';
        document.querySelectorAll('.color-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.querySelector('[data-color="#3b82f6"]').classList.add('selected');
    }

    function resetIconSelection() {
        selectedIcon = 'ph-question';
        document.querySelectorAll('.icon-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.querySelector('[data-icon="ph-question"]').classList.add('selected');
    }

    function clearRules() {
        const rulesBuilder = document.getElementById('rulesBuilder');
        const ruleItems = rulesBuilder.querySelectorAll('.rule-item');
        ruleItems.forEach(item => {
            if (!item.querySelector('.remove-rule-btn')) return; // Keep the first one
            item.remove();
        });
    }

    function addRule() {
        const rulesBuilder = document.getElementById('rulesBuilder');
        const ruleItem = document.createElement('div');
        ruleItem.className = 'rule-item';
        ruleItem.innerHTML = `
            <select class="rule-field">
                <option value="subject">Subject contains</option>
                <option value="body">Body contains</option>
                <option value="sender">Sender email contains</option>
                <option value="sender_domain">Sender domain is</option>
            </select>
            <input type="text" class="rule-value" placeholder="Enter keywords or patterns">
            <button type="button" class="remove-rule-btn" onclick="removeRule(this)">
                <i class="ph-bold ph-minus"></i>
            </button>
        `;

        rulesBuilder.appendChild(ruleItem);
    }

    function addRuleFromData(rule) {
        const rulesBuilder = document.getElementById('rulesBuilder');
        const ruleItem = document.createElement('div');
        ruleItem.className = 'rule-item';
        ruleItem.innerHTML = `
            <select class="rule-field">
                <option value="subject" ${rule.field === 'subject' ? 'selected' : ''}>Subject contains</option>
                <option value="body" ${rule.field === 'body' ? 'selected' : ''}>Body contains</option>
                <option value="sender" ${rule.field === 'sender' ? 'selected' : ''}>Sender email contains</option>
                <option value="sender_domain" ${rule.field === 'sender_domain' ? 'selected' : ''}>Sender domain is</option>
            </select>
            <input type="text" class="rule-value" placeholder="Enter keywords or patterns" value="${rule.value}">
            <button type="button" class="remove-rule-btn" onclick="removeRule(this)">
                <i class="ph-bold ph-minus"></i>
            </button>
        `;

        rulesBuilder.appendChild(ruleItem);
    }

    function removeRule(button) {
        button.closest('.rule-item').remove();
    }

    async function saveCategory() {
        const formData = {
            name: document.getElementById('categoryName').value,
            description: document.getElementById('categoryDescription').value,
            color: selectedColor,
            icon: selectedIcon,
            rules: getRulesData(),
            assignedUsers: Array.from(document.getElementById('assignedUsers').selectedOptions).map(option => parseInt(option.value))
        };

        if (!formData.name.trim()) {
            showNotification('Category name is required', 'error');
            return;
        }

        try {
            const url = currentCategoryId ?
                `/api/admin/contacts/category/${currentCategoryId}` :
                '/api/admin/contacts/categories';
            const method = currentCategoryId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                closeCategoryModal();
                loadCategoriesData();
                showNotification(`Category ${currentCategoryId ? 'updated' : 'created'} successfully`, 'success');
            } else {
                showNotification('Failed to save category', 'error');
            }
        } catch (error) {
            console.error('Error saving category:', error);
            showNotification('Error saving category', 'error');
        }
    }

    function getRulesData() {
        const rules = [];
        const ruleItems = document.querySelectorAll('.rule-item');

        ruleItems.forEach(item => {
            const field = item.querySelector('.rule-field').value;
            const value = item.querySelector('.rule-value').value.trim();

            if (value) {
                rules.push({ field, value });
            }
        });

        return rules;
    }

    function editCategory(categoryId) {
        openCategoryModal(categoryId);
    }

    function deleteCategory(categoryId) {
        if (confirm('Are you sure you want to delete this category? Messages in this category will become uncategorized.')) {
            fetch(`/api/admin/contacts/category/${categoryId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        loadCategoriesData();
                        showNotification('Category deleted successfully', 'success');
                    }
                });
        }
    }

    function toggleReorderMode() {
        // Toggle reorder mode for drag-and-drop reordering
        showNotification('Reorder functionality coming soon', 'info');
    }

    function showNotification(message, type = 'info') {
        // Use global notification system
        console.log(`${type.toUpperCase()}: ${message}`);
    }

    // Initialize when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initContactsCategories);
    } else {
        initContactsCategories();
    }
</script>