<!-- Contact Response Templates -->
<div class="contacts-templates">
    <!-- Templates Header -->
    <div class="templates-header">
        <div class="header-content">
            <h2>Response Templates</h2>
            <p>Create and manage reusable response templates for common inquiries</p>
        </div>
        <div class="header-actions">
            <button class="action-btn primary" id="createTemplateBtn">
                <i class="ph-bold ph-plus"></i>
                Create Template
            </button>
            <button class="action-btn secondary" id="importTemplatesBtn">
                <i class="ph-bold ph-upload"></i>
                Import
            </button>
        </div>
    </div>

    <!-- Templates Stats -->
    <div class="templates-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="ph-bold ph-file-text"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalTemplates">0</div>
                <div class="stat-label">Total Templates</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="ph-bold ph-cursor"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalUsage">0</div>
                <div class="stat-label">Times Used</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="ph-bold ph-tag"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="totalCategories">0</div>
                <div class="stat-label">Categories</div>
            </div>
        </div>
    </div>

    <!-- Templates Filters -->
    <div class="templates-filters">
        <div class="search-box">
            <i class="ph-bold ph-magnifying-glass"></i>
            <input type="text" id="templateSearch" placeholder="Search templates...">
        </div>
        <div class="filter-options">
            <select id="categoryFilter">
                <option value="">All Categories</option>
            </select>
            <select id="sortFilter">
                <option value="name">By Name</option>
                <option value="usage">By Usage</option>
                <option value="recent">Recently Used</option>
                <option value="created">Recently Created</option>
            </select>
        </div>
    </div>

    <!-- Templates Grid -->
    <div class="templates-grid" id="templatesGrid">
        <!-- Templates will be populated here -->
    </div>

    <!-- Template Editor Modal -->
    <div class="modal-overlay" id="templateModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Create Template</h3>
                <button class="modal-close" id="modalClose">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <div class="form-group">
                        <label for="templateName">Template Name</label>
                        <input type="text" id="templateName" required>
                    </div>
                    <div class="form-group">
                        <label for="templateCategory">Category</label>
                        <select id="templateCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="templateSubject">Email Subject</label>
                        <input type="text" id="templateSubject" required>
                    </div>
                    <div class="form-group">
                        <label for="templateBody">Email Body</label>
                        <textarea id="templateBody" rows="10" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Variables</label>
                        <div class="variables-list" id="variablesList">
                            <div class="variable-item">
                                <code>{name}</code> - Recipient's name
                            </div>
                            <div class="variable-item">
                                <code>{email}</code> - Recipient's email
                            </div>
                            <div class="variable-item">
                                <code>{company}</code> - Company name
                            </div>
                            <div class="variable-item">
                                <code>{date}</code> - Current date
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="modalCancel">Cancel</button>
                <button class="btn primary" id="modalSave">Save Template</button>
            </div>
        </div>
    </div>
</div>

<style>
    .contacts-templates {
        padding: 2rem;
    }

    /* Templates Header */
    .templates-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--admin-border);
    }

    .header-content h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--admin-text-primary);
        margin: 0 0 0.5rem 0;
    }

    .header-content p {
        color: var(--admin-text-secondary);
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-surface);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .action-btn:hover {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    .action-btn.primary {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    .action-btn.secondary {
        background: var(--admin-secondary);
        color: white;
        border-color: var(--admin-secondary);
    }

    /* Templates Stats */
    .templates-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--admin-surface);
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-lg);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--admin-radius-md);
        background: var(--admin-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--admin-text-primary);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--admin-text-secondary);
    }

    /* Templates Filters */
    .templates-filters {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--admin-surface);
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-lg);
    }

    .search-box {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        max-width: 300px;
        padding: 0.75rem;
        background: var(--admin-background);
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
    }

    .search-box i {
        color: var(--admin-text-secondary);
    }

    .search-box input {
        flex: 1;
        border: none;
        background: transparent;
        color: var(--admin-text-primary);
        font-size: 0.875rem;
    }

    .search-box input:focus {
        outline: none;
    }

    .filter-options {
        display: flex;
        gap: 1rem;
    }

    .filter-options select {
        padding: 0.5rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-surface);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
        min-width: 140px;
    }

    /* Templates Grid */
    .templates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .template-card {
        background: var(--admin-surface);
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-lg);
        padding: 1.5rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .template-card:hover {
        box-shadow: var(--admin-shadow-lg);
        transform: translateY(-2px);
    }

    .template-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .template-info {
        flex: 1;
    }

    .template-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--admin-text-primary);
        margin-bottom: 0.5rem;
    }

    .template-category {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: var(--admin-secondary);
        color: white;
        border-radius: var(--admin-radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .template-actions {
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .template-card:hover .template-actions {
        opacity: 1;
    }

    .template-action-btn {
        padding: 0.375rem;
        border: none;
        background: none;
        color: var(--admin-text-secondary);
        cursor: pointer;
        border-radius: var(--admin-radius-sm);
        transition: all 0.2s ease;
    }

    .template-action-btn:hover {
        background: var(--admin-border);
        color: var(--admin-text-primary);
    }

    .template-action-btn.edit:hover {
        background: var(--admin-primary);
        color: white;
    }

    .template-action-btn.delete:hover {
        background: var(--admin-error);
        color: white;
    }

    .template-action-btn.duplicate:hover {
        background: var(--admin-secondary);
        color: white;
    }

    .template-content {
        margin-bottom: 1rem;
    }

    .template-subject {
        font-size: 0.875rem;
        color: var(--admin-text-primary);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .template-preview {
        font-size: 0.875rem;
        color: var(--admin-text-secondary);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .template-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--admin-text-secondary);
    }

    .template-usage {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .template-usage i {
        color: var(--admin-primary);
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--admin-surface);
        border-radius: var(--admin-radius-lg);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--admin-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--admin-text-primary);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--admin-text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: var(--admin-radius-sm);
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: var(--admin-border);
        color: var(--admin-text-primary);
    }

    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--admin-text-primary);
        margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-background);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--admin-primary);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 120px;
    }

    .variables-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
        background: var(--admin-background);
        border-radius: var(--admin-radius-md);
    }

    .variable-item {
        font-size: 0.875rem;
        color: var(--admin-text-secondary);
    }

    .variable-item code {
        background: var(--admin-border);
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        font-family: 'Monaco', 'Menlo', monospace;
        color: var(--admin-primary);
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid var(--admin-border);
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius-md);
        background: var(--admin-surface);
        color: var(--admin-text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn:hover {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    .btn.secondary {
        background: var(--admin-secondary);
        color: white;
        border-color: var(--admin-secondary);
    }

    .btn.primary {
        background: var(--admin-primary);
        color: white;
        border-color: var(--admin-primary);
    }

    /* Empty State */
    .empty-state {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        text-align: center;
        color: var(--admin-text-secondary);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: var(--admin-text-primary);
    }

    .empty-state p {
        font-size: 0.875rem;
        margin-bottom: 2rem;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .templates-filters {
            flex-direction: column;
            gap: 1rem;
        }

        .filter-options {
            width: 100%;
            justify-content: space-between;
        }

        .filter-options select {
            flex: 1;
        }

        .templates-grid {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .contacts-templates {
            padding: 1rem;
        }

        .templates-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .header-actions {
            width: 100%;
            justify-content: center;
        }

        .templates-stats {
            grid-template-columns: 1fr;
        }

        .templates-grid {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 95%;
            margin: 1rem;
        }

        .modal-footer {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }
</style>

<script>
    // Contact Response Templates Management
    let currentTemplateId = null;

    function initContactsTemplates() {
        loadTemplatesData();
        setupEventListeners();
    }

    async function loadTemplatesData() {
        try {
            const response = await fetch('/api/admin/contacts/templates');
            if (response.ok) {
                const data = await response.json();
                updateTemplatesStats(data.stats);
                updateCategories(data.categories);
                updateTemplatesGrid(data.templates);
            }
        } catch (error) {
            console.error('Error loading templates data:', error);
        }
    }

    function updateTemplatesStats(stats) {
        document.getElementById('totalTemplates').textContent = stats.total || 0;
        document.getElementById('totalUsage').textContent = stats.usage || 0;
        document.getElementById('totalCategories').textContent = stats.categories || 0;
    }

    function updateCategories(categories) {
        const select = document.getElementById('categoryFilter');
        select.innerHTML = '<option value="">All Categories</option>';

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
        });

        // Also update template form categories
        const formSelect = document.getElementById('templateCategory');
        formSelect.innerHTML = '<option value="">Select Category</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            formSelect.appendChild(option.cloneNode(true));
        });
    }

    function updateTemplatesGrid(templates) {
        const container = document.getElementById('templatesGrid');

        if (!templates || templates.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="ph-bold ph-file-text"></i>
                    <h3>No templates yet</h3>
                    <p>Create your first response template to save time on common inquiries.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = templates.map(template => `
            <div class="template-card" onclick="useTemplate(${template.id})">
                <div class="template-header">
                    <div class="template-info">
                        <div class="template-name">${template.name}</div>
                        <span class="template-category">${template.category}</span>
                    </div>
                    <div class="template-actions">
                        <button class="template-action-btn edit" onclick="editTemplate(${template.id}); event.stopPropagation();" title="Edit template">
                            <i class="ph-bold ph-pencil"></i>
                        </button>
                        <button class="template-action-btn duplicate" onclick="duplicateTemplate(${template.id}); event.stopPropagation();" title="Duplicate template">
                            <i class="ph-bold ph-copy"></i>
                        </button>
                        <button class="template-action-btn delete" onclick="deleteTemplate(${template.id}); event.stopPropagation();" title="Delete template">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="template-content">
                    <div class="template-subject">${template.subject}</div>
                    <div class="template-preview">${template.preview}</div>
                </div>
                <div class="template-footer">
                    <div class="template-usage">
                        <i class="ph-bold ph-cursor"></i>
                        Used ${template.usageCount} times
                    </div>
                    <div>Last used ${formatTimeAgo(template.lastUsed)}</div>
                </div>
            </div>
        `).join('');
    }

    function setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('templateSearch');
        searchInput.addEventListener('input', debounce(() => {
            filterTemplates(searchInput.value);
        }, 300));

        // Filter changes
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('sortFilter').addEventListener('change', applyFilters);

        // Create template button
        document.getElementById('createTemplateBtn').addEventListener('click', () => {
            openTemplateModal();
        });

        // Import templates button
        document.getElementById('importTemplatesBtn').addEventListener('click', importTemplates);

        // Modal events
        document.getElementById('modalClose').addEventListener('click', closeTemplateModal);
        document.getElementById('modalCancel').addEventListener('click', closeTemplateModal);
        document.getElementById('modalSave').addEventListener('click', saveTemplate);

        // Close modal on overlay click
        document.getElementById('templateModal').addEventListener('click', (e) => {
            if (e.target.id === 'templateModal') {
                closeTemplateModal();
            }
        });
    }

    function filterTemplates(searchTerm) {
        const cards = document.querySelectorAll('.template-card');
        cards.forEach(card => {
            const text = card.textContent.toLowerCase();
            const matches = text.includes(searchTerm.toLowerCase());
            card.style.display = matches ? 'block' : 'none';
        });
    }

    function applyFilters() {
        // Apply current filters and reload data
        loadTemplatesData();
    }

    function openTemplateModal(templateId = null) {
        currentTemplateId = templateId;
        const modal = document.getElementById('templateModal');
        const title = document.getElementById('modalTitle');
        const form = document.getElementById('templateForm');

        if (templateId) {
            title.textContent = 'Edit Template';
            // Load existing template data
            loadTemplateData(templateId);
        } else {
            title.textContent = 'Create Template';
            form.reset();
        }

        modal.style.display = 'flex';
    }

    function closeTemplateModal() {
        const modal = document.getElementById('templateModal');
        modal.style.display = 'none';
        currentTemplateId = null;
        document.getElementById('templateForm').reset();
    }

    async function loadTemplateData(templateId) {
        try {
            const response = await fetch(`/api/admin/contacts/template/${templateId}`);
            if (response.ok) {
                const template = await response.json();
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateCategory').value = template.categoryId;
                document.getElementById('templateSubject').value = template.subject;
                document.getElementById('templateBody').value = template.body;
            }
        } catch (error) {
            console.error('Error loading template:', error);
        }
    }

    async function saveTemplate() {
        const formData = {
            name: document.getElementById('templateName').value,
            categoryId: document.getElementById('templateCategory').value,
            subject: document.getElementById('templateSubject').value,
            body: document.getElementById('templateBody').value
        };

        if (!formData.name || !formData.categoryId || !formData.subject || !formData.body) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }

        try {
            const url = currentTemplateId ?
                `/api/admin/contacts/template/${currentTemplateId}` :
                '/api/admin/contacts/templates';
            const method = currentTemplateId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                closeTemplateModal();
                loadTemplatesData();
                showNotification(`Template ${currentTemplateId ? 'updated' : 'created'} successfully`, 'success');
            } else {
                showNotification('Failed to save template', 'error');
            }
        } catch (error) {
            console.error('Error saving template:', error);
            showNotification('Error saving template', 'error');
        }
    }

    function editTemplate(templateId) {
        openTemplateModal(templateId);
    }

    async function duplicateTemplate(templateId) {
        try {
            const response = await fetch(`/api/admin/contacts/template/${templateId}/duplicate`, {
                method: 'POST'
            });

            if (response.ok) {
                loadTemplatesData();
                showNotification('Template duplicated successfully', 'success');
            }
        } catch (error) {
            console.error('Error duplicating template:', error);
        }
    }

    function deleteTemplate(templateId) {
        if (confirm('Are you sure you want to delete this template?')) {
            fetch(`/api/admin/contacts/template/${templateId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        loadTemplatesData();
                        showNotification('Template deleted successfully', 'success');
                    }
                });
        }
    }

    function useTemplate(templateId) {
        // This would typically open the template in the compose interface
        // For now, just show a notification
        showNotification('Template selected for use', 'info');
    }

    function importTemplates() {
        // Show file picker for importing templates
        showNotification('Import functionality coming soon', 'info');
    }

    function formatTimeAgo(timestamp) {
        if (!timestamp) return 'never';

        const now = new Date();
        const time = new Date(timestamp);
        const diff = now - time;

        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        return `${days}d ago`;
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showNotification(message, type = 'info') {
        // Use global notification system
        console.log(`${type.toUpperCase()}: ${message}`);
    }

    // Initialize when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initContactsTemplates);
    } else {
        initContactsTemplates();
    }
</script>